{% extends "base.html" %}
{% block title %}All The Subs - Sub Search{% endblock %}

{% block content %}
<!-- Header -->
<div class="card mb-4">
  <div class="card-body p-4">
    <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-3">
      <div>
        <p class="stat-label mb-2">The Menu</p>
        <h1 class="h3 mb-2">All The Subs</h1>
        <p class="text-muted mb-0">Browse our ever-growing directory of {{ stats.total_subreddits|default:"3M+" }} subreddits</p>
        {% if initial_filters.job_id %}
        <div class="mt-3 d-inline-flex align-items-center gap-2 px-3 py-2 rounded" style="background-color: rgba(255, 214, 53, 0.1); border: 1px solid rgba(255, 214, 53, 0.3);">
          <span class="text-warning small">Filtered by job:</span>
          <span class="fw-semibold small">{{ initial_filters.job_id|truncatechars:12 }}</span>
          <a href="{% url 'all_subs' %}" class="text-muted ms-2">&times; Clear</a>
        </div>
        {% endif %}
      </div>
      <a href="{% url 'home' %}" class="btn btn-primary">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
        </svg>
        New Search
      </a>
    </div>
  </div>
</div>

<!-- Filters -->
<div class="card mb-4">
  <div class="card-body">
    <div class="d-flex align-items-center gap-3 mb-4">
      <div class="rounded d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; background-color: rgba(255, 214, 53, 0.2);">
        <svg width="18" height="18" class="text-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
        </svg>
      </div>
      <h5 class="mb-0">Filter Your Order</h5>
    </div>

    <div class="row g-3">
      <div class="col-sm-6 col-lg-3">
        <label for="filter-q" class="form-label">Keyword</label>
        <input type="text" class="form-control" id="filter-q" placeholder="Search subs...">
      </div>
      <div class="col-sm-6 col-lg-3">
        <label for="filter-min-subs" class="form-label">Min Subscribers</label>
        <input type="number" class="form-control" id="filter-min-subs" min="0" step="100" placeholder="0">
      </div>
      <div class="col-sm-6 col-lg-3">
        <label for="filter-unmoderated" class="form-label">Moderation</label>
        <select class="form-select" id="filter-unmoderated">
          <option value="">All subs</option>
          <option value="true">Unmoderated only</option>
          <option value="false">Moderated only</option>
        </select>
      </div>
      <div class="col-sm-6 col-lg-3">
        <label for="filter-nsfw" class="form-label">Content Type</label>
        <select class="form-select" id="filter-nsfw">
          <option value="">All content</option>
          <option value="false">SFW only</option>
          <option value="true">NSFW only</option>
        </select>
      </div>
    </div>

    <div class="mt-4 d-flex flex-wrap align-items-center justify-content-between gap-3">
      <div class="d-flex align-items-center gap-4">
        <button type="button" id="reset-filters" class="btn btn-link btn-sm">Reset Filters</button>
        <span id="table-summary" class="small text-muted">Loading...</span>
      </div>
      <div class="d-flex align-items-center gap-2">
        <label for="page-size" class="small text-muted mb-0">Show:</label>
        <select class="form-select form-select-sm" id="page-size" style="width: 80px;">
          <option value="25">25</option>
          <option value="50" selected>50</option>
          <option value="100">100</option>
        </select>
      </div>
    </div>
  </div>
</div>

<!-- Table -->
<div class="card">
  <div class="table-responsive">
    <table class="table table-hover mb-0" id="subs-table">
      <thead>
        <tr>
          <th data-sort="name" style="width: 200px;">
            <span class="d-flex align-items-center gap-1">Subreddit <span class="sort-indicator"></span></span>
          </th>
          <th>Description</th>
          <th data-sort="subscribers" class="text-end" style="width: 120px;">
            <span class="d-flex align-items-center justify-content-end gap-1">Subscribers <span class="sort-indicator"></span></span>
          </th>
          <th data-sort="mod_count" class="text-end" style="width: 100px;">
            <span class="d-flex align-items-center justify-content-end gap-1">Mods <span class="sort-indicator"></span></span>
          </th>
          <th data-sort="mod_activity" style="width: 140px;">
            <span class="d-flex align-items-center gap-1">Mod Activity <span class="sort-indicator"></span></span>
          </th>
          <th data-sort="updated_at" style="width: 140px;">
            <span class="d-flex align-items-center gap-1">Indexed <span class="sort-indicator"></span></span>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="6" class="text-center py-5 text-muted">Loading fresh subs...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="d-flex align-items-center justify-content-center gap-3 border-top border-custom p-3">
    <button type="button" id="prev-page" class="btn btn-secondary btn-sm">
      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
      Previous
    </button>
    <span id="page-indicator" class="small text-muted" style="min-width: 100px; text-align: center;">Page 1</span>
    <button type="button" id="next-page" class="btn btn-secondary btn-sm">
      Next
      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
      </svg>
    </button>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ initial_filters|json_script:"initial-filters-data" }}
<style>
.table-sortable th[data-sort] {
  cursor: pointer;
  user-select: none;
}
.table-sortable th[data-sort]:hover {
  color: var(--ss-text);
}
.table-sortable th.active {
  color: var(--ss-warning);
}
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
</style>
<script>
const initialFilters = JSON.parse(document.getElementById('initial-filters-data').textContent);
const state = {
  q: initialFilters.q || '',
  min_subs: initialFilters.min_subs || '',
  unmoderated: initialFilters.unmoderated || '',
  nsfw: initialFilters.nsfw || '',
  sort: initialFilters.sort || 'subscribers',
  order: (initialFilters.order || 'desc').toLowerCase() === 'asc' ? 'asc' : 'desc',
  page: 1,
  total: 0,
  pageSize: 50,
  job_id: initialFilters.job_id || '',
};

// DOM elements
const qInput = document.getElementById('filter-q');
const minSubsInput = document.getElementById('filter-min-subs');
const unmodSelect = document.getElementById('filter-unmoderated');
const nsfwSelect = document.getElementById('filter-nsfw');
const pageSizeSelect = document.getElementById('page-size');
const tableBody = document.querySelector('#subs-table tbody');
const tableSummary = document.getElementById('table-summary');
const pageIndicator = document.getElementById('page-indicator');

// Initialize form values
qInput.value = state.q;
minSubsInput.value = state.min_subs;
if (state.unmoderated) unmodSelect.value = state.unmoderated;
if (state.nsfw) nsfwSelect.value = state.nsfw;

// Debounced update
let debounceTimer = null;
const debouncedUpdate = () => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() => { state.page = 1; loadSubs(); }, 300);
};

// Event listeners
qInput.addEventListener('input', () => { state.q = qInput.value.trim(); debouncedUpdate(); });
minSubsInput.addEventListener('input', () => { state.min_subs = minSubsInput.value; debouncedUpdate(); });
unmodSelect.addEventListener('change', () => { state.unmoderated = unmodSelect.value; state.page = 1; loadSubs(); });
nsfwSelect.addEventListener('change', () => { state.nsfw = nsfwSelect.value; state.page = 1; loadSubs(); });
pageSizeSelect.addEventListener('change', () => { state.pageSize = parseInt(pageSizeSelect.value); state.page = 1; loadSubs(); });

document.getElementById('reset-filters').addEventListener('click', () => {
  state.q = ''; state.min_subs = ''; state.unmoderated = ''; state.nsfw = '';
  qInput.value = ''; minSubsInput.value = ''; unmodSelect.value = ''; nsfwSelect.value = '';
  state.page = 1; loadSubs();
});

document.getElementById('prev-page').addEventListener('click', () => {
  if (state.page > 1) { state.page -= 1; loadSubs(); }
});

document.getElementById('next-page').addEventListener('click', () => {
  const maxPage = Math.ceil(state.total / state.pageSize) || 1;
  if (state.page < maxPage) { state.page += 1; loadSubs(); }
});

// Sorting
document.querySelectorAll('#subs-table th[data-sort]').forEach(th => {
  th.addEventListener('click', () => {
    const key = th.getAttribute('data-sort');
    if (state.sort === key) {
      state.order = state.order === 'asc' ? 'desc' : 'asc';
    } else {
      state.sort = key;
      state.order = key === 'name' ? 'asc' : 'desc';
    }
    state.page = 1;
    updateSortIndicators();
    loadSubs();
  });
});

function updateSortIndicators() {
  document.querySelectorAll('#subs-table th[data-sort]').forEach(th => {
    const indicator = th.querySelector('.sort-indicator');
    const key = th.getAttribute('data-sort');
    if (key === state.sort) {
      indicator.textContent = state.order === 'asc' ? '↑' : '↓';
      th.classList.add('active');
    } else {
      indicator.textContent = '';
      th.classList.remove('active');
    }
  });
}

// Utility functions
function formatNumber(v) { return v == null ? '—' : Number(v).toLocaleString(); }
function formatDate(v) {
  if (!v) return '—';
  const d = new Date(v);
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}
function formatEpoch(v) {
  if (v == null) return '—';
  const n = Number(v);
  if (!Number.isFinite(n) || n <= 0) return '—';
  return new Date(n * 1000).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}
function escapeHtml(s) {
  return s ? String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])) : '';
}
function safeUrl(u) { return u?.startsWith('http') ? u : '#'; }
function truncate(s, len) {
  if (!s) return '';
  return s.length > len ? s.substring(0, len) + '...' : s;
}

// Load data
async function loadSubs() {
  tableSummary.textContent = 'Loading...';
  tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-muted">Loading fresh subs...</td></tr>';

  const params = new URLSearchParams();
  if (state.q) params.set('q', state.q);
  if (state.min_subs) params.set('min_subs', state.min_subs);
  if (state.unmoderated) params.set('unmoderated', state.unmoderated);
  if (state.nsfw) params.set('nsfw', state.nsfw);
  params.set('sort', state.sort);
  params.set('order', state.order);
  params.set('page', String(state.page));
  params.set('page_size', String(state.pageSize));
  if (state.job_id) params.set('job_id', state.job_id);

  try {
    const res = await fetch(`/api/subreddits?${params.toString()}`);
    if (!res.ok) throw new Error('Request failed');
    const data = await res.json();
    state.total = data.total || 0;
    renderRows(data.rows || []);
    const maxPage = Math.max(1, Math.ceil(state.total / state.pageSize));
    pageIndicator.textContent = `Page ${state.page} of ${maxPage}`;
    const filtersActive = [state.q, state.min_subs, state.unmoderated, state.nsfw].some(Boolean);
    tableSummary.textContent = `${formatNumber(state.total)} subs${filtersActive ? ' (filtered)' : ''}`;

    // Update pagination buttons
    document.getElementById('prev-page').disabled = state.page <= 1;
    document.getElementById('next-page').disabled = state.page >= maxPage;
  } catch (e) {
    tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-danger">Failed to load subs. Please try again.</td></tr>';
    tableSummary.textContent = 'Error';
  }
}

function renderRows(rows) {
  if (!rows.length) {
    tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-muted">No subs match your filters. Try adjusting your order.</td></tr>';
    return;
  }

  tableBody.innerHTML = rows.map(row => {
    const badges = [];
    if (row.is_unmoderated) badges.push('<span class="badge bg-success">Unmoderated</span>');
    if (row.is_nsfw) badges.push('<span class="badge bg-danger">NSFW</span>');

    return `
      <tr>
        <td>
          <a class="fw-semibold text-success" href="${safeUrl(row.url)}" target="_blank" rel="noopener">
            ${escapeHtml(row.display_name_prefixed || 'r/' + row.name)}
          </a>
          ${badges.length ? `<div class="mt-1 d-flex flex-wrap gap-1">${badges.join('')}</div>` : ''}
        </td>
        <td>
          <p class="fw-medium mb-0">${escapeHtml(row.title) || escapeHtml('r/' + row.name)}</p>
          <p class="small text-muted mb-0 line-clamp-2">${escapeHtml(truncate(row.public_description, 120)) || 'No description'}</p>
        </td>
        <td class="text-end fw-semibold">${formatNumber(row.subscribers)}</td>
        <td class="text-end">${row.mod_count != null ? formatNumber(row.mod_count) : '—'}</td>
        <td class="small text-muted">${formatEpoch(row.last_mod_activity_utc)}</td>
        <td class="small text-muted">${formatDate(row.updated_at)}</td>
      </tr>
    `;
  }).join('');
}

// Initialize
updateSortIndicators();
loadSubs();
</script>
{% endblock %}
