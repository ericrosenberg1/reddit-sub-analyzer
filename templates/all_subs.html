{% extends "base.html" %}
{% block title %}All The Subs - Sub Search{% endblock %}

{% block content %}
<section class="panel-surface p-6 lg:p-10">
  <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
    <div>
      <p class="section-label">All The Subs</p>
      <h1 class="font-display text-3xl sm:text-4xl">The continuously growing subreddit directory</h1>
      {% if initial_filters.job_id %}
      <p class="mt-2 data-chip">
        Showing job {{ initial_filters.job_id }}
        <a href="{% url 'all_subs' %}" class="ml-2 hover:text-white">Clear</a>
      </p>
      {% endif %}
    </div>
    <a href="{% url 'home' %}" class="nav-link active">Run a Sub Search</a>
  </div>

  <!-- Filters -->
  <div class="mt-8 grid gap-4 md:grid-cols-2 lg:grid-cols-4">
    <div class="card p-4">
      <p class="section-label">Filter</p>
      <input type="text" id="filter-q" placeholder="Keyword" class="mt-2 text-sm">
    </div>
    <div class="card p-4">
      <p class="section-label">Min subscribers</p>
      <input type="number" id="filter-min-subs" min="0" step="100" placeholder="0" class="mt-2 text-sm">
    </div>
    <div class="card p-4">
      <p class="section-label">Moderated</p>
      <select id="filter-unmoderated" class="mt-2 text-sm">
        <option value="">All subs</option>
        <option value="true">Unmoderated only</option>
        <option value="false">Moderated included</option>
      </select>
    </div>
    <div class="card p-4">
      <p class="section-label">NSFW</p>
      <select id="filter-nsfw" class="mt-2 text-sm">
        <option value="">All</option>
        <option value="false">Exclude NSFW</option>
        <option value="true">Only NSFW</option>
      </select>
    </div>
  </div>
  <div class="mt-3 flex flex-wrap items-center gap-3 text-xs">
    <button type="button" id="reset-filters" class="nav-link text-xs">Reset filters</button>
    <span id="table-summary" class="text-muted">Loading…</span>
  </div>

  <!-- Table -->
  <div class="mt-6 card overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-[720px]" id="subs-table">
        <thead>
          <tr>
            <th data-sort="name">Subreddit</th>
            <th>Title & description</th>
            <th data-sort="subscribers">Subscribers</th>
            <th data-sort="mod_count">Moderators</th>
            <th data-sort="mod_activity">Last mod activity</th>
            <th data-sort="updated_at">Last indexed</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="6" class="text-center py-6 text-muted">Loading…</td></tr>
        </tbody>
      </table>
    </div>
    <div class="flex items-center justify-between border-t border-white/10 px-4 py-4 text-xs">
      <button type="button" id="prev-page" class="nav-link text-xs">← Prev</button>
      <span id="page-indicator" class="text-muted">Page 1</span>
      <button type="button" id="next-page" class="nav-link text-xs">Next →</button>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
{{ initial_filters|json_script:"initial-filters-data" }}
<script>
const initialFilters = JSON.parse(document.getElementById('initial-filters-data').textContent);
const state = {
  q: initialFilters.q || '',
  min_subs: initialFilters.min_subs || '',
  unmoderated: initialFilters.unmoderated || '',
  nsfw: initialFilters.nsfw || '',
  sort: initialFilters.sort || 'subscribers',
  order: (initialFilters.order || 'desc').toLowerCase() === 'asc' ? 'asc' : 'desc',
  page: 1,
  total: 0,
  pageSize: 50,
  job_id: initialFilters.job_id || '',
};

const qInput = document.getElementById('filter-q');
const minSubsInput = document.getElementById('filter-min-subs');
const unmodSelect = document.getElementById('filter-unmoderated');
const nsfwSelect = document.getElementById('filter-nsfw');
const tableBody = document.querySelector('#subs-table tbody');
const tableSummary = document.getElementById('table-summary');
const pageIndicator = document.getElementById('page-indicator');

qInput.value = state.q;
minSubsInput.value = state.min_subs;
if (state.unmoderated) unmodSelect.value = state.unmoderated;
if (state.nsfw) nsfwSelect.value = state.nsfw;

let debounceTimer = null;
const debouncedUpdate = () => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() => { state.page = 1; loadSubs(); }, 250);
};

qInput.addEventListener('input', () => { state.q = qInput.value.trim(); debouncedUpdate(); });
minSubsInput.addEventListener('input', () => { state.min_subs = minSubsInput.value; debouncedUpdate(); });
unmodSelect.addEventListener('change', () => { state.unmoderated = unmodSelect.value; state.page = 1; loadSubs(); });
nsfwSelect.addEventListener('change', () => { state.nsfw = nsfwSelect.value; state.page = 1; loadSubs(); });

document.getElementById('reset-filters').addEventListener('click', () => {
  state.q = ''; state.min_subs = ''; state.unmoderated = ''; state.nsfw = '';
  qInput.value = ''; minSubsInput.value = ''; unmodSelect.value = ''; nsfwSelect.value = '';
  state.page = 1; loadSubs();
});

document.getElementById('prev-page').addEventListener('click', () => {
  if (state.page > 1) { state.page -= 1; loadSubs(); }
});
document.getElementById('next-page').addEventListener('click', () => {
  const maxPage = Math.ceil(state.total / state.pageSize) || 1;
  if (state.page < maxPage) { state.page += 1; loadSubs(); }
});

document.querySelectorAll('#subs-table th[data-sort]').forEach(th => {
  th.addEventListener('click', () => {
    const key = th.getAttribute('data-sort');
    if (state.sort === key) {
      state.order = state.order === 'asc' ? 'desc' : 'asc';
    } else {
      state.sort = key;
      state.order = key === 'name' ? 'asc' : 'desc';
    }
    state.page = 1; loadSubs();
  });
});

function formatNumber(v) { return v == null ? '—' : Number(v).toLocaleString(); }
function formatDate(v) { return v ? v.replace('T', ' ').replace('+00:00', ' UTC') : '—'; }
function formatEpoch(v) {
  if (v == null) return '—';
  const n = Number(v);
  if (!Number.isFinite(n) || n <= 0) return '—';
  return new Date(n * 1000).toISOString().replace('T', ' ').replace('Z', ' UTC');
}
function escapeHtml(s) { return s ? String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])) : ''; }
function safeUrl(u) { return u?.startsWith('http') ? u : '#'; }

async function loadSubs() {
  tableSummary.textContent = 'Loading…';
  tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-6 text-muted">Loading…</td></tr>';

  const params = new URLSearchParams();
  if (state.q) params.set('q', state.q);
  if (state.min_subs) params.set('min_subs', state.min_subs);
  if (state.unmoderated) params.set('unmoderated', state.unmoderated);
  if (state.nsfw) params.set('nsfw', state.nsfw);
  params.set('sort', state.sort);
  params.set('order', state.order);
  params.set('page', String(state.page));
  params.set('page_size', String(state.pageSize));
  if (state.job_id) params.set('job_id', state.job_id);

  try {
    const res = await fetch(`/api/subreddits?${params.toString()}`);
    if (!res.ok) throw new Error('Request failed');
    const data = await res.json();
    state.total = data.total || 0;
    renderRows(data.rows || []);
    const maxPage = Math.max(1, Math.ceil(state.total / state.pageSize));
    pageIndicator.textContent = `Page ${state.page} of ${maxPage}`;
    const filtersActive = [state.q, state.min_subs, state.unmoderated, state.nsfw].some(Boolean);
    tableSummary.textContent = `${formatNumber(state.total)} subreddits${filtersActive ? ' • filtered' : ''}`;
  } catch (e) {
    tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-6 text-red-300">Unable to load subreddits. Please try again.</td></tr>';
    tableSummary.textContent = 'Error loading results.';
  }
}

function renderRows(rows) {
  if (!rows.length) {
    tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-6 text-muted">No subreddits match the current filters.</td></tr>';
    return;
  }
  tableBody.innerHTML = rows.map(row => {
    const flags = [];
    if (row.is_unmoderated) flags.push('<span class="badge badge-success">Unmoderated</span>');
    if (row.is_nsfw) flags.push('<span class="badge badge-error">NSFW</span>');
    return `
      <tr>
        <td>
          <a class="font-semibold underline decoration-dotted" href="${safeUrl(row.url)}" target="_blank" rel="noopener">${escapeHtml(row.display_name_prefixed || 'r/' + row.name)}</a>
          <div class="mt-1 flex flex-wrap gap-1">${flags.join('')}</div>
        </td>
        <td>
          <p class="font-semibold">${escapeHtml(row.title) || 'r/' + escapeHtml(row.name)}</p>
          <p class="clamp-2 text-xs text-muted">${escapeHtml(row.public_description) || 'No description provided yet.'}</p>
        </td>
        <td>${formatNumber(row.subscribers)}</td>
        <td>${row.mod_count != null ? formatNumber(row.mod_count) : '—'}</td>
        <td>${formatEpoch(row.last_mod_activity_utc)}</td>
        <td>${formatDate(row.updated_at)}</td>
      </tr>
    `;
  }).join('');
}

loadSubs();
</script>
{% endblock %}
