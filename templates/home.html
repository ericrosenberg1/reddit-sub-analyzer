{% extends "base.html" %}
{% load static %}
{% block title %}Sub Search - Reddit Subreddit Discovery{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="panel-surface p-6 lg:p-10">
  <div class="flex flex-col gap-6 lg:flex-row lg:items-start lg:justify-between">
    <div class="max-w-2xl space-y-4">
      <p class="section-label">An <a href="https://ericrosenberg.com" class="hover:text-white">Eric Rosenberg</a> project</p>
      <h1 class="font-display text-4xl sm:text-5xl">Sub Search + All The Subs</h1>
      <p class="text-lg">Sub Search keeps a living index of subreddit names, descriptions, moderator counts, and last human moderator activity so you can analyze communities and export targeted lists.</p>
      <div class="flex flex-wrap gap-3 pt-2">
        <a href="{% url 'all_subs' %}" class="nav-link">Browse All The Subs</a>
        <a href="https://github.com/ericrosenberg1/reddit-sub-analyzer" target="_blank" rel="noopener" class="nav-link">View on GitHub</a>
      </div>
    </div>
    <div class="flex flex-col gap-4 lg:w-80">
      <img src="{% static 'img/sub-sando-hero.svg' %}" alt="Sub Search" class="hero-art w-full max-w-[200px] mx-auto rounded-3xl border border-white/10 bg-slate-900/40 p-3">
    </div>
  </div>
</section>

<!-- Stats Bar -->
<section class="mt-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
  <div class="card p-4">
    <p class="section-label">Total indexed</p>
    <p class="stat-value">{{ stats.total_subreddits|default:0 }}</p>
  </div>
  <div class="card p-4">
    <p class="section-label">Total searches</p>
    <p class="stat-value">{{ stats.total_runs|default:0 }}</p>
  </div>
  <div class="card p-4">
    <p class="section-label">In queue</p>
    <p class="stat-value text-sky-300">{{ queue_count|default:0 }}</p>
  </div>
  <div class="card p-4">
    <p class="section-label">Last indexed</p>
    <p class="local-time text-lg font-semibold" data-ts="{{ stats.last_indexed|date:'c' }}">{{ stats.last_indexed|date:"M d, Y"|default:"pending" }}</p>
  </div>
</section>

<!-- Search Form -->
<section class="panel-surface mt-10 p-6 lg:p-10">
  <h2 class="mb-6">Sub Search</h2>
  <form method="post" action="{% url 'home' %}" id="run-form">
    {% csrf_token %}
    <div class="grid gap-6 lg:grid-cols-2">
      <!-- Left Column: Main Inputs -->
      <div class="space-y-4">
        <div>
          <label for="keyword">Subreddit name contains</label>
          <input type="text" id="keyword" name="keyword" placeholder="e.g. fintech, outdoor, language" maxlength="64" pattern="[A-Za-z0-9 _\-]*">
        </div>
        <div class="grid gap-4 sm:grid-cols-2">
          <div>
            <label for="limit">Max subs to check</label>
            <input type="text" id="limit" name="limit" inputmode="numeric" pattern="[0-9,]*" value="1,000">
          </div>
          <div>
            <label for="min_subs">Min subscribers</label>
            <input type="text" id="min_subs" name="min_subs" inputmode="numeric" pattern="[0-9,]*" value="0">
          </div>
        </div>
        <div>
          <label for="notification_email">Email me when done (optional)</label>
          <input type="email" id="notification_email" name="notification_email" placeholder="you@example.com">
        </div>
      </div>
      <!-- Right Column: Options -->
      <div class="space-y-4">
        <div class="card p-4">
          <p class="section-label mb-3">Filter options</p>
          <label class="flex items-center gap-3 cursor-pointer mb-3">
            <input type="checkbox" id="unmoderated_only" name="unmoderated_only" class="rounded">
            <span>Only show unmoderated subreddits</span>
          </label>
          <label class="flex items-center gap-3 cursor-pointer mb-0">
            <input type="checkbox" id="exclude_nsfw" name="exclude_nsfw" class="rounded">
            <span>Exclude NSFW subreddits</span>
          </label>
        </div>
        <div class="card p-4">
          <label class="flex items-center gap-3 cursor-pointer mb-3">
            <input type="checkbox" id="activity_enabled" name="activity_enabled" class="rounded">
            <span class="font-semibold">Enable activity filter</span>
          </label>
          <div class="grid gap-3 sm:grid-cols-2">
            <div>
              <label for="activity_mode" class="text-xs">Mode</label>
              <select id="activity_mode" name="activity_mode" disabled>
                <option value="any">Any activity</option>
                <option value="active_after">Active since date</option>
                <option value="inactive_before">Inactive since date</option>
              </select>
            </div>
            <div>
              <label for="activity_date" class="text-xs">Date</label>
              <input type="date" id="activity_date" name="activity_date" disabled>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="mt-6">
      <button type="submit" class="w-full text-lg py-4">Find Your Subs</button>
    </div>
  </form>

  <!-- Job Status Panel -->
  <div id="run-state" class="mt-6 card p-6 {% if not job_id %}hidden{% endif %}">
    <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
      <div class="flex items-center gap-4">
        <div class="loader" id="status-loader"></div>
        <div>
          <p id="status-title" class="text-lg font-semibold">Waiting for the sandwich counter...</p>
          <p id="status-sub" class="text-sm text-muted">-</p>
        </div>
      </div>
      <div class="grid grid-cols-3 gap-6 text-center">
        <div>
          <p class="stat-label">Checked</p>
          <p id="checked" class="stat-value text-2xl">0</p>
        </div>
        <div>
          <p class="stat-label">Found</p>
          <p id="found" class="stat-value text-2xl text-brand">0</p>
        </div>
        <div>
          <p class="stat-label">Limit</p>
          <p id="limit_count" class="stat-value text-2xl text-muted">0</p>
        </div>
      </div>
    </div>
    <div class="mt-4 flex justify-end">
      <button id="stopBtn" class="btn-danger px-4 py-2 text-sm rounded-xl">Stop Search</button>
    </div>
  </div>

  <!-- Results Panel -->
  <div id="results-panel" class="mt-6 card p-6 hidden">
    <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
      <div>
        <h3 id="results-title">Results</h3>
        <p id="results-subtitle" class="text-sm text-muted">-</p>
      </div>
      <div class="flex gap-3">
        <a id="download-btn" href="#" class="btn-secondary px-4 py-2 text-sm rounded-xl pointer-events-none opacity-50">Download CSV</a>
        <a id="view-all-btn" href="#" class="btn-secondary px-4 py-2 text-sm rounded-xl pointer-events-none opacity-50">View in All The Subs</a>
      </div>
    </div>
  </div>
</section>

<!-- Queue + Activity Row -->
<div class="mt-10 grid gap-6 lg:grid-cols-2">
  <!-- Queue Status -->
  <section class="panel-surface p-6" id="queue-status-section" style="display: none;">
    <div class="flex items-center justify-between mb-4">
      <div>
        <p class="section-label">Search Queue</p>
        <h2>Upcoming searches</h2>
      </div>
      <span class="text-sm text-muted"><span id="total-queued">0</span> queued</span>
    </div>
    <div class="card overflow-hidden">
      <table class="w-full text-sm" id="queue-table">
        <thead>
          <tr>
            <th class="w-12">#</th>
            <th>Keyword</th>
            <th class="text-right">Limit</th>
            <th class="text-center">Type</th>
            <th class="text-right">ETA</th>
          </tr>
        </thead>
        <tbody id="queue-list"></tbody>
      </table>
    </div>
  </section>

  <!-- Recent Searches -->
  <section class="panel-surface p-6">
    <div class="flex items-center justify-between mb-4">
      <div>
        <p class="section-label">Activity</p>
        <h2>Recent searches</h2>
      </div>
      <a href="{% url 'logs' %}" class="nav-link text-sm">View all</a>
    </div>
    <div class="card overflow-hidden">
      <table class="w-full text-sm">
        <thead>
          <tr>
            <th>Keyword</th>
            <th class="text-right">Results</th>
            <th class="text-center">Status</th>
            <th>When</th>
          </tr>
        </thead>
        <tbody id="recent-searches-list">
          {% if recent_user_runs %}
          {% for run in recent_user_runs %}
          <tr data-run-id="{{ run.job_id }}">
            <td class="font-semibold">{{ run.keyword|default:"All subs"|truncatechars:20 }}</td>
            <td class="text-right result-count tabular-nums">{{ run.result_count|default:0 }}</td>
            <td class="text-center">
              <span class="status-badge badge {% if run.completed_at %}badge-success{% elif run.error %}badge-error{% else %}badge-info{% endif %}">
                {% if run.completed_at %}done{% elif run.error %}error{% else %}running{% endif %}
              </span>
            </td>
            <td class="local-time whitespace-nowrap" data-ts="{{ run.started_at|date:'c' }}">{{ run.started_at|date:"M d"|default:"-" }}</td>
          </tr>
          {% endfor %}
          {% else %}
          <tr><td colspan="4" class="text-center text-muted py-4">No searches yet</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </section>
</div>

<!-- Auto Search Bot Section -->
<section class="panel-surface mt-10 p-6">
  <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
    <div>
      <p class="section-label">Always growing</p>
      <h2>The Sub Builder Bot</h2>
      {% if random_run %}
      <p class="mt-2 text-sm">
        Currently searching <span class="font-semibold text-white">"{{ random_run.keyword|default:"random" }}"</span>
        with limit {{ random_run.limit_value|default:"2000" }}
      </p>
      <p class="mt-1 text-xs text-muted">{{ random_run.result_count|default:0 }} subs collected so far</p>
      {% else %}
      <p class="mt-2 text-sm text-muted">Bot is idle</p>
      {% endif %}
    </div>
    <div class="text-right">
      <p class="text-xs text-muted uppercase tracking-widest">Auto-search interval</p>
      <p class="text-lg font-semibold">{{ random_search_interval }} min</p>
    </div>
  </div>
</section>

<!-- Features Grid -->
<section class="mt-10 grid gap-4 md:grid-cols-3">
  <article class="card p-5">
    <p class="section-label">Always growing</p>
    <h3 class="mt-2">Automatic database expansion</h3>
    <p class="mt-2 text-sm">Every search is saved in the public database, and random subreddits are added automatically.</p>
  </article>
  <article class="card p-5">
    <p class="section-label">Community powered</p>
    <h3 class="mt-2">Distributed node network</h3>
    <p class="mt-2 text-sm">Anyone can run a node that feeds the main database, fueling faster growth and fresher results.</p>
  </article>
  <article class="card p-5">
    <p class="section-label">One search at a time</p>
    <h3 class="mt-2">Queued search processing</h3>
    <p class="mt-2 text-sm">Only one search runs at a time to protect Reddit's API limits. Others wait in queue with real-time ETA updates.</p>
  </article>
</section>

<!-- Nodes CTA Section -->
<section class="panel-surface mt-10 p-6">
  <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
    <div>
      <p class="section-label">Distributed help</p>
      <h2>Run a volunteer node</h2>
      <p class="mt-2 text-sm">Bring your machine + Reddit account to help grow the dataset faster.</p>
    </div>
    <div class="flex items-center gap-6">
      <div class="text-center">
        <p class="stat-value">{{ node_stats.total|default:0 }}</p>
        <p class="text-xs text-muted">Nodes</p>
      </div>
      <a href="{% url 'node_join' %}" class="btn-primary px-6 py-3 whitespace-nowrap">Add a node</a>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

function formatLocalTime(ts) {
  if (!ts) return '-';
  const date = new Date(ts);
  if (Number.isNaN(date.getTime())) return '-';
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function formatETA(seconds) {
  if (seconds < 60) return `${seconds}s`;
  const minutes = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return secs > 0 ? `${minutes}m ${secs}s` : `${minutes}m`;
}

function refreshLocalTimeElements() {
  document.querySelectorAll('.local-time').forEach(el => {
    el.textContent = formatLocalTime(el.getAttribute('data-ts'));
  });
}

async function refreshQueueStatus() {
  try {
    const response = await fetch('/api/queue?limit=10');
    if (!response.ok) return;
    const data = await response.json();
    if (!data) return;

    const section = document.getElementById('queue-status-section');
    const queueList = document.getElementById('queue-list');
    document.getElementById('total-queued').textContent = data.total_queued || 0;

    if (data.queue?.length > 0) {
      section.style.display = 'block';
      queueList.innerHTML = data.queue.map(item => `
        <tr>
          <td class="text-center font-bold text-subtle">${item.position}</td>
          <td class="font-semibold">${item.keyword}</td>
          <td class="text-right tabular-nums">${Number(item.limit).toLocaleString()}</td>
          <td class="text-center"><span class="badge ${item.is_manual ? 'badge-success' : 'badge-neutral'}">${item.is_manual ? 'User' : 'Auto'}</span></td>
          <td class="text-right whitespace-nowrap">${formatETA(item.eta_completion_seconds)}</td>
        </tr>
      `).join('');
    } else {
      section.style.display = 'none';
    }
  } catch (e) { console.error('Queue refresh failed:', e); }
}

async function refreshRecentSearches() {
  try {
    const response = await fetch('/api/recent-runs?limit=5');
    if (!response.ok) return;
    const data = await response.json();
    if (!data?.runs) return;

    const listEl = document.getElementById('recent-searches-list');
    data.runs.forEach((run, i) => {
      let item = listEl.querySelector(`[data-run-id="${run.job_id}"]`);
      if (item) {
        const badge = item.querySelector('.status-badge');
        const status = run.completed_at ? 'done' : (run.error ? 'error' : 'running');
        if (badge) {
          badge.className = `status-badge badge badge-${status === 'done' ? 'success' : status === 'error' ? 'error' : 'info'}`;
          badge.textContent = status;
        }
        const count = item.querySelector('.result-count');
        if (count) count.textContent = run.result_count || 0;
      }
    });
  } catch (e) { console.error('Recent searches refresh failed:', e); }
}

const jobIdFromServer = {% if job_id %}"{{ job_id }}"{% else %}null{% endif %};
let pollTimer = null;
let activeJobId = jobIdFromServer;

async function fetchStatus(id) {
  try {
    const res = await fetch(`/status/${id}`);
    if (!res.ok) return;
    const data = await res.json();
    if (!data) return;
    updateStatusUi(data);
    if (data.done && pollTimer) {
      clearInterval(pollTimer);
      pollTimer = null;
    }
  } catch (e) { console.error(e); }
}

function updateStatusUi(data) {
  const limit = Number(data.limit || data.job_config?.limit || 0);
  const checked = Number(data.checked || 0);
  const found = Number(data.found || 0);

  document.getElementById('limit_count').textContent = limit.toLocaleString();
  document.getElementById('checked').textContent = checked.toLocaleString();
  document.getElementById('found').textContent = found.toLocaleString();

  const state = data.state || (data.done ? 'complete' : 'running');
  const statusTitle = document.getElementById('status-title');
  const statusSub = document.getElementById('status-sub');

  if (state === 'queued') {
    statusTitle.textContent = 'Queued...';
    statusSub.textContent = 'Waiting for available slot';
  } else if (state === 'running') {
    statusTitle.textContent = 'Running search...';
    statusSub.textContent = `Checking subreddits for "${data.keyword || 'all'}"`;
  } else if (state === 'error') {
    statusTitle.textContent = 'Error';
    statusSub.textContent = data.error || 'Unknown error';
  } else {
    statusTitle.textContent = state === 'stopped' ? 'Search stopped' : 'Search complete';
    statusSub.textContent = data.error || 'Results ready below.';
  }

  document.getElementById('stopBtn').disabled = !!data.done;

  if (data.done && data.results_ready) {
    document.getElementById('run-state').classList.add('hidden');
    document.getElementById('results-panel').classList.remove('hidden');
    const total = Number(data.result_count || found);
    document.getElementById('results-title').textContent = `${total.toLocaleString()} subreddits found`;
    document.getElementById('results-subtitle').textContent = 'Use the buttons to download or view in All The Subs.';
    const dlBtn = document.getElementById('download-btn');
    const viewBtn = document.getElementById('view-all-btn');
    dlBtn.href = `/job/${activeJobId}/download.csv`;
    dlBtn.classList.remove('pointer-events-none', 'opacity-50');
    viewBtn.href = `/all-the-subs?job_id=${encodeURIComponent(activeJobId)}`;
    viewBtn.classList.remove('pointer-events-none', 'opacity-50');
  }
}

document.getElementById('activity_enabled')?.addEventListener('change', function() {
  const mode = document.getElementById('activity_mode');
  const date = document.getElementById('activity_date');
  mode.disabled = !this.checked;
  date.disabled = !this.checked;
  if (!this.checked) { mode.value = 'any'; date.value = ''; }
});

document.getElementById('stopBtn')?.addEventListener('click', async function() {
  if (!activeJobId) return;
  try {
    const res = await fetch(`/stop/${activeJobId}`, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/json' }
    });
    if (res.ok) {
      if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
      fetchStatus(activeJobId);
    }
  } catch (e) { console.error(e); }
});

document.addEventListener('DOMContentLoaded', () => {
  refreshLocalTimeElements();
  refreshRecentSearches();
  refreshQueueStatus();
  setInterval(refreshRecentSearches, 5000);
  setInterval(refreshQueueStatus, 3000);

  if (activeJobId) {
    document.getElementById('run-state').classList.remove('hidden');
    fetchStatus(activeJobId);
    pollTimer = setInterval(() => fetchStatus(activeJobId), 1000);
  }
});
</script>
{% endblock %}
