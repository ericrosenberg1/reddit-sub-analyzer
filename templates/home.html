{% extends "base.html" %}
{% load static humanize %}
{% block title %}Sub Search - Reddit Subreddit Discovery{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="card mb-4">
  <div class="card-body p-4">
    <div class="row align-items-center">
      <div class="col-lg-8">
        <h1 class="h2 mb-2">Sub Search</h1>
        <p class="text-muted mb-0">Reddit Subreddit Discovery Tool</p>
      </div>
      <div class="col-lg-4 mt-3 mt-lg-0">
        <p class="text-muted small mb-0">
          Search Reddit's API for subreddits matching your keywords. Filter by subscribers, mod activity, and more. Every search adds to our shared database.
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Stats + Search Form Row -->
<div class="row g-4 mb-4">
  <!-- Left: LCARS Stats Panel -->
  <div class="col-lg-6">
    <div class="lcars-panel h-100">
      <div class="lcars-scan-line"></div>
      <div class="lcars-header">
        <span class="lcars-header-text">Database Stats</span>
      </div>
      <div class="lcars-body">
        <div class="lcars-stat">
          <span class="lcars-stat-label">Subs Indexed</span>
          <span class="lcars-stat-value accent">{{ stats.total_subreddits|default:0|intcomma }}</span>
        </div>
        <div class="lcars-stat">
          <span class="lcars-stat-label">Total Searches</span>
          <span class="lcars-stat-value">{{ stats.total_runs|default:0|intcomma }}</span>
        </div>
        <div class="lcars-stat">
          <span class="lcars-stat-label">In Queue</span>
          <span class="lcars-stat-value" id="lcars-queue-count">{{ queue_count|default:0 }}</span>
        </div>
        <div class="lcars-stat">
          <span class="lcars-stat-label">Last Completed</span>
          <span class="lcars-stat-value" style="font-size: 14px;">
            <span class="local-time" data-ts="{{ stats.last_run_started|date:'c' }}">{{ stats.last_run_started|date:"M d, H:i"|default:"—" }}</span>
          </span>
        </div>
      </div>

      <!-- Live Queue Status - LCARS Style -->
      <div class="lcars-live-section">
        <div class="lcars-live-header">
          <span class="lcars-live-dot" id="live-indicator"></span>
          <span class="lcars-live-title">Live Queue</span>
        </div>
        <div class="lcars-live-row">
          <span class="lcars-live-label">Current Search:</span>
          <span class="lcars-live-value" id="current-keyword">—</span>
        </div>
        <div class="lcars-live-row" id="current-progress-row" style="display: none;">
          <span class="lcars-live-label">Progress:</span>
          <span class="lcars-live-value" id="current-progress">0 / 0</span>
        </div>
        <div class="lcars-live-row">
          <span class="lcars-live-label">Human Queue:</span>
          <span class="lcars-live-value" id="user-queue-count">0 waiting</span>
        </div>
        <div class="lcars-live-row" id="countdown-row">
          <span class="lcars-live-label">Next Auto Search:</span>
          <span class="lcars-countdown" id="next-search-countdown">calculating...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Right: Search Form -->
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-body">
        <h6 class="card-title">New Search</h6>
        <form method="post" action="{% url 'home' %}" id="run-form">
          {% csrf_token %}

          <div class="mb-3">
            <label for="keyword" class="form-label">Keyword <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="keyword" name="keyword" placeholder="e.g. gaming, crypto, cooking" maxlength="64" pattern="[A-Za-z0-9 _\-]+" required>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-4">
              <label for="limit" class="form-label">Max Results</label>
              <input type="text" class="form-control" id="limit" name="limit" inputmode="numeric" pattern="[0-9,]*" value="1,000">
            </div>
            <div class="col-4">
              <label for="min_subs" class="form-label">Min Subs</label>
              <input type="text" class="form-control" id="min_subs" name="min_subs" inputmode="numeric" pattern="[0-9,]*" value="0">
            </div>
            <div class="col-4">
              <label for="notification_email" class="form-label">Notify Email</label>
              <input type="email" class="form-control" id="notification_email" name="notification_email" placeholder="optional">
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-6">
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="unmoderated_only" name="unmoderated_only">
                <label class="form-check-label" for="unmoderated_only">Unmoderated only</label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="exclude_nsfw" name="exclude_nsfw">
                <label class="form-check-label" for="exclude_nsfw">Exclude NSFW</label>
              </div>
            </div>
          </div>

          <!-- Advanced: Mod Activity Filter -->
          <div class="bg-input rounded p-3 mb-3">
            <div class="form-check mb-2">
              <input type="checkbox" class="form-check-input" id="activity_enabled" name="activity_enabled">
              <label class="form-check-label fw-medium" for="activity_enabled">Filter by mod activity</label>
            </div>
            <div class="row g-2">
              <div class="col-6">
                <select class="form-select form-select-sm" id="activity_mode" name="activity_mode" disabled>
                  <option value="any">Any activity</option>
                  <option value="active_after">Active since</option>
                  <option value="inactive_before">Inactive since</option>
                </select>
              </div>
              <div class="col-6">
                <input type="date" class="form-control form-control-sm" id="activity_date" name="activity_date" disabled>
              </div>
            </div>
          </div>

          <button type="submit" class="btn btn-primary w-100 py-2">
            <svg class="me-1" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            Start Search
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Search Status Modal -->
<div class="modal fade" id="search-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Search in Progress</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex align-items-center gap-3 mb-4">
          <div class="spinner-border" role="status" id="status-loader">
            <span class="visually-hidden">Loading...</span>
          </div>
          <div>
            <p id="status-title" class="fw-bold mb-0">Preparing search...</p>
            <p id="status-sub" class="text-muted small mb-0">—</p>
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-4">
            <div class="text-center bg-input rounded p-3">
              <p class="stat-label mb-1">Checked</p>
              <p id="checked" class="h5 fw-bold mb-0">0</p>
            </div>
          </div>
          <div class="col-4">
            <div class="text-center bg-input rounded p-3">
              <p class="stat-label mb-1">Found</p>
              <p id="found" class="h5 fw-bold text-success mb-0">0</p>
            </div>
          </div>
          <div class="col-4">
            <div class="text-center bg-input rounded p-3">
              <p class="stat-label mb-1">Limit</p>
              <p id="limit_count" class="h5 fw-bold text-muted mb-0">0</p>
            </div>
          </div>
        </div>

        <button type="button" id="stopBtn" class="btn btn-danger w-100">Stop Search</button>

        <!-- Results (shown when complete) -->
        <div id="results-panel" class="border-top border-custom mt-4 pt-4 d-none">
          <h6 id="results-title" class="text-success mb-2">Results Ready!</h6>
          <p id="results-subtitle" class="text-muted small mb-3">Your search is complete</p>
          <div class="d-flex gap-2">
            <a id="download-btn" href="#" class="btn btn-secondary flex-fill">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
              </svg>
              Download CSV
            </a>
            <a id="view-all-btn" href="#" class="btn btn-primary flex-fill">View Results</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Recent Results + Queue Row -->
<div class="row g-4 mb-4">
  <!-- Left: Recent Search Results -->
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h6 class="card-title mb-0">Recent Search Results</h6>
          <a href="{% url 'logs' %}" class="small text-muted">View All</a>
        </div>
        <div id="recent-searches-list">
          {% if recent_user_runs %}
          {% for run in recent_user_runs %}
          <div class="list-group-item d-flex align-items-center justify-content-between mb-2 rounded" data-run-id="{{ run.job_id }}">
            <div>
              <p class="fw-medium small mb-0">{{ run.keyword|default:"All subreddits" }}</p>
              <p class="text-muted small mb-0">
                <span class="result-count">{{ run.result_count|default:0 }} subs</span> &middot;
                <span class="local-time" data-ts="{{ run.started_at|date:'c' }}">{{ run.started_at|date:"M d, H:i"|default:"—" }}</span>
              </p>
            </div>
            <span class="status-badge badge {% if run.completed_at %}bg-success{% elif run.error %}bg-danger{% else %}bg-info{% endif %}">
              {% if run.completed_at %}done{% elif run.error %}error{% else %}running{% endif %}
            </span>
          </div>
          {% endfor %}
          {% else %}
          <p class="text-muted text-center py-4 mb-0">No searches yet</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Right: Current Queue -->
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h6 class="card-title mb-0">Search Queue</h6>
          <span id="queue-badge" class="badge bg-secondary">{{ queue_count|default:0 }} pending</span>
        </div>
        <div id="queue-list">
          <p class="text-muted text-center py-4 mb-0">Loading...</p>
        </div>

        <!-- Auto Bot Status -->
        <div class="border-top border-custom mt-4 pt-4">
          <div class="d-flex align-items-center gap-2 mb-2">
            <svg width="16" height="16" class="text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
            <span class="stat-label">Auto Search Bot</span>
          </div>
          {% if random_run %}
          <p class="small mb-0">Last: "{{ random_run.keyword|default:"random" }}" — {{ random_run.result_count|default:0 }} subs</p>
          {% else %}
          <p class="text-muted small mb-0">Bot is idle</p>
          {% endif %}
          <p class="text-muted small mb-0">Runs every {{ random_search_interval }} min</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Data Tables Row -->
<div class="row g-4 mb-4">
  <!-- Left: Index History -->
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-body">
        <h6 class="card-title">Index Statistics</h6>
        <table class="table table-sm mb-3">
          <tbody>
            <tr>
              <td class="text-muted border-0">Total Searches</td>
              <td class="text-end fw-medium border-0">{{ stats.total_runs|default:0|intcomma }}</td>
            </tr>
            <tr>
              <td class="text-muted">Index Size</td>
              <td class="text-end fw-medium">{{ stats.total_subreddits|default:0|intcomma }} subs</td>
            </tr>
            <tr>
              <td class="text-muted">Subs Updated (24h)</td>
              <td class="text-end fw-medium">{{ stats.subs_updated_24h|default:0|intcomma }}</td>
            </tr>
            <tr>
              <td class="text-muted">Manual Searches</td>
              <td class="text-end fw-medium">{{ stats.manual_searches|default:0|intcomma }}</td>
            </tr>
            <tr>
              <td class="text-muted">Bot Searches</td>
              <td class="text-end fw-medium">{{ stats.bot_searches|default:0|intcomma }}</td>
            </tr>
          </tbody>
        </table>
        <a href="{% url 'all_subs' %}" class="btn btn-secondary w-100">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
          </svg>
          Browse All Subs
        </a>
      </div>
    </div>
  </div>

  <!-- Right: Volunteer Nodes -->
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-body">
        <h6 class="card-title">Volunteer Network</h6>
        <table class="table table-sm mb-3">
          <tbody>
            <tr>
              <td class="text-muted border-0">Active Nodes</td>
              <td class="text-end fw-medium border-0">{{ node_stats.active_nodes|default:0 }}</td>
            </tr>
            <tr>
              <td class="text-muted">Total Nodes</td>
              <td class="text-end fw-medium">{{ node_stats.total_nodes|default:0 }}</td>
            </tr>
            <tr>
              <td class="text-muted">Searches by Nodes</td>
              <td class="text-end fw-medium">{{ node_stats.node_searches|default:0|intcomma }}</td>
            </tr>
            <tr>
              <td class="text-muted">Subs Contributed</td>
              <td class="text-end fw-medium">{{ node_stats.subs_contributed|default:0|intcomma }}</td>
            </tr>
            <tr>
              <td class="text-muted">Network Uptime</td>
              <td class="text-end fw-medium text-success">{{ node_stats.uptime|default:"—" }}</td>
            </tr>
          </tbody>
        </table>
        <a href="{% url 'nodes_home' %}" class="btn btn-secondary w-100">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2"/>
          </svg>
          Set Up a Node
        </a>
      </div>
    </div>
  </div>
</div>

<!-- How It Works Section -->
<div class="card">
  <div class="card-body">
    <div class="row">
      <!-- Left 2/3: Steps -->
      <div class="col-lg-8">
        <h6 class="card-title">How It Works</h6>

        <!-- Step 1 -->
        <div class="d-flex align-items-start gap-3 mb-3">
          <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0" style="width: 40px; height: 40px; background-color: var(--ss-accent);">
            <span class="text-white fw-bold">1</span>
          </div>
          <div class="pt-1">
            <p class="fw-bold mb-1">Configure Your Search</p>
            <p class="text-muted small mb-0">Enter keywords, set subscriber minimums, and choose filters. Optionally get email notifications.</p>
          </div>
        </div>

        <!-- Connector -->
        <div class="ms-3 border-start border-custom" style="height: 16px; margin-left: 20px !important;"></div>

        <!-- Step 2 -->
        <div class="d-flex align-items-start gap-3 mb-3">
          <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0" style="width: 40px; height: 40px; background-color: var(--ss-accent);">
            <span class="text-white fw-bold">2</span>
          </div>
          <div class="pt-1">
            <p class="fw-bold mb-1">We Query Reddit's API</p>
            <p class="text-muted small mb-0">Our servers fetch fresh data on subreddit names, descriptions, mod activity, and subscriber counts.</p>
          </div>
        </div>

        <!-- Connector -->
        <div class="ms-3 border-start border-custom" style="height: 16px; margin-left: 20px !important;"></div>

        <!-- Step 3 -->
        <div class="d-flex align-items-start gap-3">
          <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0" style="width: 40px; height: 40px; background-color: var(--ss-accent);">
            <span class="text-white fw-bold">3</span>
          </div>
          <div class="pt-1">
            <p class="fw-bold mb-1">Results Join the Database</p>
            <p class="text-muted small mb-0">Download your CSV or browse results online. Every search contributes to our shared public index.</p>
          </div>
        </div>
      </div>

      <!-- Right 1/3: Quick Info -->
      <div class="col-lg-4 border-start border-custom ps-lg-4 mt-4 mt-lg-0">
        <h6 class="card-title">Quick Facts</h6>
        <div class="d-flex flex-column gap-2 small">
          <div class="d-flex align-items-center gap-2">
            <svg width="20" height="20" class="text-success flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            <span>100% free to use</span>
          </div>
          <div class="d-flex align-items-center gap-2">
            <svg width="20" height="20" class="text-success flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            <span>No account required</span>
          </div>
          <div class="d-flex align-items-center gap-2">
            <svg width="20" height="20" class="text-success flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            <span>Export to CSV</span>
          </div>
          <div class="d-flex align-items-center gap-2">
            <svg width="20" height="20" class="text-success flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            <span>Real-time progress</span>
          </div>
          <div class="d-flex align-items-center gap-2">
            <svg width="20" height="20" class="text-success flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            <span>Open source</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
const RANDOM_SEARCH_INTERVAL = {{ random_search_interval|default:30 }};
let lastSearchEndTime = null;
let countdownInterval = null;

function formatLocalTime(ts) {
  if (!ts) return '—';
  const date = new Date(ts);
  if (Number.isNaN(date.getTime())) return '—';
  return date.toLocaleString('en-US', {
    month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true
  });
}

function refreshLocalTimeElements() {
  document.querySelectorAll('.local-time').forEach(el => {
    const ts = el.getAttribute('data-ts');
    if (ts) el.textContent = formatLocalTime(ts);
  });
}

// Modal handling with Bootstrap
const modalEl = document.getElementById('search-modal');
const searchModal = modalEl ? new bootstrap.Modal(modalEl) : null;

function showModal() {
  if (searchModal) searchModal.show();
}

function hideModal() {
  if (searchModal) searchModal.hide();
}

// Countdown timer
function updateCountdown() {
  const countdownEl = document.getElementById('next-search-countdown');
  const countdownRowEl = document.getElementById('countdown-row');
  const currentKeywordEl = document.getElementById('current-keyword');

  // If something is running, hide countdown
  if (currentKeywordEl && currentKeywordEl.textContent !== 'Idle' && currentKeywordEl.textContent !== '—') {
    countdownRowEl.style.display = 'none';
    return;
  }

  countdownRowEl.style.display = 'flex';

  if (!lastSearchEndTime) {
    countdownEl.textContent = `~${RANDOM_SEARCH_INTERVAL} min`;
    return;
  }

  const nextSearchTime = new Date(lastSearchEndTime.getTime() + RANDOM_SEARCH_INTERVAL * 60 * 1000);
  const now = new Date();
  const diffMs = nextSearchTime - now;

  if (diffMs <= 0) {
    countdownEl.textContent = 'any moment...';
  } else {
    const diffMins = Math.floor(diffMs / 60000);
    const diffSecs = Math.floor((diffMs % 60000) / 1000);
    if (diffMins > 0) {
      countdownEl.textContent = `${diffMins}m ${diffSecs}s`;
    } else {
      countdownEl.textContent = `${diffSecs}s`;
    }
  }
}

// Live status updates
async function refreshLiveStatus() {
  try {
    const queueRes = await fetch('/api/queue?limit=10');
    if (queueRes.ok) {
      const data = await queueRes.json();

      // Update "Current Search" section
      const currentKeywordEl = document.getElementById('current-keyword');
      const progressRowEl = document.getElementById('current-progress-row');
      const progressEl = document.getElementById('current-progress');

      if (data.running) {
        currentKeywordEl.textContent = data.running.keyword || 'searching...';
        currentKeywordEl.style.color = 'var(--ss-success)';
        if (data.running.checked > 0 || data.running.found > 0) {
          progressRowEl.style.display = 'flex';
          progressEl.textContent = `${data.running.found} found / ${data.running.checked} checked`;
        }
      } else {
        currentKeywordEl.textContent = 'Idle';
        currentKeywordEl.style.color = 'var(--lcars-tan)';
        progressRowEl.style.display = 'none';
      }

      // Count user (manual) jobs in queue
      const userJobs = (data.queue || []).filter(j => j.is_manual);
      document.getElementById('user-queue-count').textContent =
        userJobs.length > 0 ? `${userJobs.length} waiting` : 'none';

      // Update queue badge and LCARS queue count
      document.getElementById('queue-badge').textContent = `${data.total_queued || 0} pending`;
      const lcarsQueueCount = document.getElementById('lcars-queue-count');
      if (lcarsQueueCount) lcarsQueueCount.textContent = data.total_queued || 0;

      // Render the queue list
      const queueListEl = document.getElementById('queue-list');
      if (data.running || (data.queue && data.queue.length > 0)) {
        let html = '';

        // Show running job first
        if (data.running) {
          const sourceLabel = data.running.is_manual ? 'user' : 'bot';
          html += `
            <div class="list-group-item d-flex align-items-center justify-content-between mb-2 rounded">
              <div>
                <p class="fw-medium small mb-0">"${escapeHtml(data.running.keyword)}"</p>
                <p class="text-muted small mb-0">${data.running.found} found / ${data.running.checked} checked</p>
              </div>
              <span class="badge bg-success">running</span>
            </div>`;
        }

        // Show queued jobs
        (data.queue || []).forEach(job => {
          const sourceLabel = job.is_manual ? 'user' : 'bot';
          const badgeClass = job.is_manual ? 'bg-warning' : 'bg-info';
          html += `
            <div class="list-group-item d-flex align-items-center justify-content-between mb-2 rounded">
              <div>
                <p class="fw-medium small mb-0">"${escapeHtml(job.keyword)}"</p>
                <p class="text-muted small mb-0">${sourceLabel} • limit ${job.limit}</p>
              </div>
              <span class="badge ${badgeClass}">queued</span>
            </div>`;
        });

        queueListEl.innerHTML = html || '<p class="text-muted text-center py-4 mb-0">Queue is empty</p>';
      } else {
        queueListEl.innerHTML = '<p class="text-muted text-center py-4 mb-0">Queue is empty</p>';
      }
    }

    const runsRes = await fetch('/api/recent-runs?limit=5');
    if (runsRes.ok) {
      const data = await runsRes.json();
      if (data.runs) {
        const listEl = document.getElementById('recent-searches-list');
        data.runs.forEach(run => {
          const item = listEl.querySelector(`[data-run-id="${run.job_id}"]`);
          if (item) {
            const badge = item.querySelector('.status-badge');
            const status = run.completed_at ? 'done' : (run.error ? 'error' : 'running');
            if (badge) {
              badge.className = `status-badge badge bg-${status === 'done' ? 'success' : status === 'error' ? 'danger' : 'info'}`;
              badge.textContent = status;
            }
            const count = item.querySelector('.result-count');
            if (count) count.textContent = `${run.result_count || 0} subs`;
          }
        });
      }
    }
  } catch (e) {
    console.error('Status refresh failed:', e);
  }
}

function escapeHtml(s) {
  return s ? String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : '';
}

// Job polling
const jobIdFromServer = {% if job_id %}"{{ job_id }}"{% else %}null{% endif %};
let pollTimer = null;
let activeJobId = jobIdFromServer;

async function fetchStatus(id) {
  try {
    const res = await fetch(`/status/${id}/`);
    if (!res.ok) return;
    const data = await res.json();
    if (!data) return;
    updateStatusUi(data);
    if (data.done && pollTimer) {
      clearInterval(pollTimer);
      pollTimer = null;
    }
  } catch (e) { console.error(e); }
}

function updateStatusUi(data) {
  const limit = Number(data.limit || data.job_config?.limit || 0);
  const checked = Number(data.checked || 0);
  const found = Number(data.found || 0);

  document.getElementById('limit_count').textContent = limit.toLocaleString();
  document.getElementById('checked').textContent = checked.toLocaleString();
  document.getElementById('found').textContent = found.toLocaleString();

  const state = data.state || (data.done ? 'complete' : 'running');
  const statusTitle = document.getElementById('status-title');
  const statusSub = document.getElementById('status-sub');
  const loader = document.getElementById('status-loader');

  if (state === 'queued') {
    statusTitle.textContent = 'In the queue...';
    statusSub.textContent = 'Waiting for your turn';
  } else if (state === 'running') {
    statusTitle.textContent = 'Searching...';
    statusSub.textContent = `Keyword: "${data.keyword || 'all'}"`;
  } else if (state === 'error') {
    statusTitle.textContent = 'Search failed';
    statusSub.textContent = data.error || 'Unknown error';
    loader.style.display = 'none';
  } else {
    statusTitle.textContent = state === 'stopped' ? 'Search cancelled' : 'Search complete!';
    statusSub.textContent = '';
    loader.style.display = 'none';
  }

  document.getElementById('stopBtn').disabled = !!data.done;

  if (data.done && data.results_ready) {
    document.getElementById('results-panel').classList.remove('d-none');
    const total = Number(data.result_count || found);
    document.getElementById('results-title').textContent = `${total.toLocaleString()} subs found!`;
    document.getElementById('results-subtitle').textContent = 'Your search is complete';
    const dlBtn = document.getElementById('download-btn');
    const viewBtn = document.getElementById('view-all-btn');
    dlBtn.href = `/job/${activeJobId}/download.csv`;
    viewBtn.href = `/all-the-subs/?job_id=${encodeURIComponent(activeJobId)}`;
  }
}

// Activity filter toggle
document.getElementById('activity_enabled')?.addEventListener('change', function() {
  const mode = document.getElementById('activity_mode');
  const date = document.getElementById('activity_date');
  mode.disabled = !this.checked;
  date.disabled = !this.checked;
  if (!this.checked) { mode.value = 'any'; date.value = ''; }
});

// Stop button
document.getElementById('stopBtn')?.addEventListener('click', async function() {
  if (!activeJobId) return;
  try {
    const res = await fetch(`/stop/${activeJobId}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/json' }
    });
    if (res.ok) {
      if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
      fetchStatus(activeJobId);
    }
  } catch (e) { console.error(e); }
});

// Fetch last completed search time for countdown
async function fetchLastSearchTime() {
  try {
    const res = await fetch('/api/recent-runs?limit=1&source=random');
    if (res.ok) {
      const data = await res.json();
      if (data.runs && data.runs.length > 0 && data.runs[0].completed_at) {
        lastSearchEndTime = new Date(data.runs[0].completed_at);
      }
    }
  } catch (e) {
    console.error('Failed to fetch last search time:', e);
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', async () => {
  refreshLocalTimeElements();
  await fetchLastSearchTime();
  refreshLiveStatus();
  updateCountdown();

  setInterval(refreshLiveStatus, 3000);
  countdownInterval = setInterval(updateCountdown, 1000);

  if (activeJobId) {
    showModal();
    fetchStatus(activeJobId);
    pollTimer = setInterval(() => fetchStatus(activeJobId), 1000);
  }
});
</script>
{% endblock %}
