{% extends "base.html" %}
{% load static humanize %}
{% block title %}Sub Search - Reddit Subreddit Discovery{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="card mb-4">
  <div class="card-body p-4">
    <div class="row align-items-center">
      <div class="col-lg-8">
        <h1 class="h2 mb-2">Sub Search</h1>
        <p class="text-muted mb-0">Reddit Subreddit Discovery Tool</p>
      </div>
      <div class="col-lg-4 mt-3 mt-lg-0">
        <p class="text-muted small mb-0">
          Search Reddit's API for subreddits matching your keywords. Filter by subscribers, mod activity, and more. Every search adds to our shared database.
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Stats + Search Form Row -->
<div class="row g-4 mb-4">
  <!-- Left: LCARS Stats Panel -->
  <div class="col-lg-6">
    <div class="lcars-panel h-100">
      <div class="lcars-scan-line"></div>
      <div class="lcars-header">
        <span class="lcars-header-text">Database Stats</span>
      </div>
      <div class="lcars-body">
        <div class="lcars-stat">
          <span class="lcars-stat-label">Subs Indexed</span>
          <span class="lcars-stat-value accent">{{ stats.total_subreddits|default:0|intcomma }}</span>
        </div>
        <div class="lcars-stat">
          <span class="lcars-stat-label">Total Searches</span>
          <span class="lcars-stat-value">{{ stats.total_runs|default:0|intcomma }}</span>
        </div>
        <div class="lcars-stat">
          <span class="lcars-stat-label">In Queue</span>
          <span class="lcars-stat-value" id="lcars-queue-count">{{ queue_count|default:0 }}</span>
        </div>
        <div class="lcars-stat">
          <span class="lcars-stat-label">Last Completed</span>
          <span class="lcars-stat-value" style="font-size: 14px;">
            <span class="local-time" data-ts="{{ stats.last_run_started|date:'c' }}">{{ stats.last_run_started|date:"M d, H:i"|default:"—" }}</span>
          </span>
        </div>
      </div>

      <!-- Live Queue Status - LCARS Style -->
      <div class="lcars-live-section">
        <div class="lcars-live-header">
          <span class="lcars-live-dot" id="live-indicator"></span>
          <span class="lcars-live-title">Live Queue</span>
        </div>
        <div class="lcars-live-row">
          <span class="lcars-live-label">Current Search:</span>
          <span class="lcars-live-value" id="current-keyword">—</span>
        </div>
        <div class="lcars-live-row" id="current-progress-row" style="display: none;">
          <span class="lcars-live-label">Progress:</span>
          <span class="lcars-live-value" id="current-progress">0 / 0</span>
        </div>
        <div class="lcars-live-row">
          <span class="lcars-live-label">Human Queue:</span>
          <span class="lcars-live-value" id="user-queue-count">0 waiting</span>
        </div>
        <div class="lcars-live-row" id="countdown-row">
          <span class="lcars-live-label">Next Auto Search:</span>
          <span class="lcars-countdown" id="next-search-countdown">calculating...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Right: Search Form -->
  <div class="col-lg-6">
    <div class="lcars-panel h-100">
      <div class="lcars-scan-line"></div>
      <div class="lcars-header">
        <span class="lcars-header-text">New Search</span>
      </div>
      <div class="lcars-body">
        <form method="post" action="{% url 'home' %}" id="run-form">
          {% csrf_token %}

          <div class="mb-3">
            <label for="keyword" class="form-label">Keyword <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="keyword" name="keyword" placeholder="e.g. gaming, crypto, cooking" maxlength="64" pattern="[A-Za-z0-9 _\-]+" required>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-4">
              <label for="limit" class="form-label">Max Results</label>
              <input type="text" class="form-control" id="limit" name="limit" inputmode="numeric" pattern="[0-9,]*" value="1,000">
            </div>
            <div class="col-4">
              <label for="min_subs" class="form-label">Min Subs</label>
              <input type="text" class="form-control" id="min_subs" name="min_subs" inputmode="numeric" pattern="[0-9,]*" value="0">
            </div>
            <div class="col-4">
              <label for="notification_email" class="form-label">Notify Email</label>
              <input type="email" class="form-control" id="notification_email" name="notification_email" placeholder="optional">
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-6">
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="unmoderated_only" name="unmoderated_only">
                <label class="form-check-label" for="unmoderated_only">Unmoderated only</label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="exclude_nsfw" name="exclude_nsfw">
                <label class="form-check-label" for="exclude_nsfw">Exclude NSFW</label>
              </div>
            </div>
          </div>

          <!-- Advanced: Mod Activity Filter -->
          <div class="bg-input rounded p-3 mb-3">
            <div class="form-check mb-2">
              <input type="checkbox" class="form-check-input" id="activity_enabled" name="activity_enabled">
              <label class="form-check-label fw-medium" for="activity_enabled">Filter by mod activity</label>
            </div>
            <div class="row g-2">
              <div class="col-6">
                <select class="form-select form-select-sm" id="activity_mode" name="activity_mode" disabled>
                  <option value="any">Any activity</option>
                  <option value="active_after">Active since</option>
                  <option value="inactive_before">Inactive since</option>
                </select>
              </div>
              <div class="col-6">
                <input type="date" class="form-control form-control-sm" id="activity_date" name="activity_date" disabled>
              </div>
            </div>
          </div>

          <button type="submit" class="btn btn-primary w-100 py-2">
            <svg class="me-1" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            Start Search
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Recent Results + Queue Row -->
<div class="row g-4 mb-4">
  <!-- Left: Recent Search Results -->
  <div class="col-lg-6">
    <div class="lcars-panel h-100">
      <div class="lcars-scan-line"></div>
      <div class="lcars-header">
        <span class="lcars-header-text">Recent Search Results</span>
        <a href="{% url 'logs' %}" class="ms-auto small" style="color: var(--lcars-tan);">View All</a>
      </div>
      <div class="lcars-body">
        <div id="recent-searches-list">
          {% if recent_user_runs %}
          {% for run in recent_user_runs %}
          <div class="list-group-item d-flex align-items-center justify-content-between mb-2 rounded" data-run-id="{{ run.job_id }}" data-keyword="{{ run.keyword|default:'' }}" data-started="{{ run.started_at|date:'c' }}" data-completed="{{ run.completed_at|date:'c'|default:'' }}">
            <div class="flex-grow-1 me-2">
              <p class="fw-medium small mb-0">{{ run.keyword|default:"All subreddits" }}</p>
              <p class="text-muted small mb-0">
                <span class="result-count">{{ run.result_count|default:0 }} subs</span> &middot;
                <span class="local-time" data-ts="{{ run.started_at|date:'c' }}">{{ run.started_at|date:"M d, H:i"|default:"—" }}</span>
                {% if run.completed_at and run.started_at %}
                <span class="duration-display" data-started="{{ run.started_at|date:'c' }}" data-completed="{{ run.completed_at|date:'c' }}"></span>
                {% endif %}
              </p>
            </div>
            <div class="d-flex align-items-center gap-2">
              {% if run.completed_at %}
              <a href="{% url 'all_subs' %}?keyword={{ run.keyword|urlencode }}" class="btn btn-sm btn-secondary {% if run.result_count == 0 %}disabled opacity-50{% endif %}" title="View Results" {% if run.result_count == 0 %}aria-disabled="true" tabindex="-1"{% endif %}>
                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
              </a>
              <a href="/job/{{ run.job_id }}/download.csv" class="btn btn-sm btn-secondary {% if run.result_count == 0 %}disabled opacity-50{% endif %}" title="Download CSV" {% if run.result_count == 0 %}aria-disabled="true" tabindex="-1"{% endif %}>
                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
              </a>
              {% endif %}
              <span class="status-badge badge {% if run.completed_at %}bg-success{% elif run.error %}bg-danger{% else %}bg-info{% endif %}">
                {% if run.completed_at %}done{% elif run.error %}error{% else %}running{% endif %}
              </span>
            </div>
          </div>
          {% endfor %}
          {% else %}
          <p class="text-muted text-center py-4 mb-0">No searches yet</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Right: Current Queue -->
  <div class="col-lg-6">
    <div class="lcars-panel h-100">
      <div class="lcars-scan-line"></div>
      <div class="lcars-header">
        <span class="lcars-header-text">Search Queue</span>
        <span id="queue-badge" class="ms-auto badge bg-secondary">{{ queue_count|default:0 }} pending</span>
      </div>
      <div class="lcars-body">
        <div id="queue-list">
          <p class="text-muted text-center py-4 mb-0">Loading...</p>
        </div>
      </div>

      <!-- Auto Bot Status -->
      <div class="lcars-live-section">
        <div class="lcars-live-header">
          <svg width="14" height="14" style="color: var(--lcars-blue);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
          </svg>
          <span class="lcars-live-title">Auto Search Bot</span>
        </div>
        {% if random_run %}
        <div class="lcars-live-row">
          <span class="lcars-live-label">Last Run:</span>
          <span class="lcars-live-value">"{{ random_run.keyword|default:"random" }}" — {{ random_run.result_count|default:0 }} subs</span>
        </div>
        {% else %}
        <div class="lcars-live-row">
          <span class="lcars-live-label">Status:</span>
          <span class="lcars-live-value" style="color: var(--lcars-tan);">Idle</span>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Index Statistics (24h) -->
    <div class="lcars-panel mt-4">
      <div class="lcars-scan-line"></div>
      <div class="lcars-header">
        <span class="lcars-header-text">24-Hour Activity</span>
        <span class="ms-auto small" style="color: var(--lcars-tan);" id="stats-updated-at" data-ts="{{ rolling_stats.updated_at|date:'c'|default:'' }}"></span>
      </div>
      <div class="lcars-body">
        <table class="table table-sm mb-3">
          <tbody>
            <tr>
              <td class="text-muted border-0">Subs Discovered</td>
              <td class="text-end fw-medium border-0">{{ rolling_stats.subs_discovered_24h|default:0|intcomma }}</td>
            </tr>
            <tr>
              <td class="text-muted">Subs Updated</td>
              <td class="text-end fw-medium">{{ rolling_stats.subs_updated_24h|default:0|intcomma }}</td>
            </tr>
            <tr>
              <td class="text-muted">Human Searches</td>
              <td class="text-end fw-medium">{{ rolling_stats.human_searches_24h|default:0|intcomma }}</td>
            </tr>
            <tr>
              <td class="text-muted">Bot Searches</td>
              <td class="text-end fw-medium">{{ rolling_stats.bot_searches_24h|default:0|intcomma }}</td>
            </tr>
          </tbody>
        </table>
        <a href="{% url 'all_subs' %}" class="btn btn-secondary w-100">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
          </svg>
          Browse All Subs
        </a>
      </div>
    </div>

    <!-- SubSearch Nodes -->
    <div class="lcars-panel mt-4">
      <div class="lcars-scan-line"></div>
      <div class="lcars-header">
        <span class="lcars-header-text">SubSearch Nodes</span>
      </div>
      <div class="lcars-body">
        <table class="table table-sm mb-3">
          <tbody>
            <tr>
              <td class="text-muted border-0">Active Nodes</td>
              <td class="text-end fw-medium border-0">{{ node_stats.active_nodes|default:0 }}</td>
            </tr>
            <tr>
              <td class="text-muted">Total Nodes</td>
              <td class="text-end fw-medium">{{ node_stats.total_nodes|default:0 }}</td>
            </tr>
            <tr>
              <td class="text-muted">Searches by Nodes</td>
              <td class="text-end fw-medium">{{ node_stats.node_searches|default:0|intcomma }}</td>
            </tr>
            <tr>
              <td class="text-muted">Subs Contributed</td>
              <td class="text-end fw-medium">{{ node_stats.subs_contributed|default:0|intcomma }}</td>
            </tr>
            <tr>
              <td class="text-muted">Network Uptime</td>
              <td class="text-end fw-medium text-success">{{ node_stats.uptime|default:"—" }}</td>
            </tr>
          </tbody>
        </table>
        <a href="{% url 'nodes_home' %}" class="btn btn-secondary w-100">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2"/>
          </svg>
          Set Up a Node
        </a>
      </div>
    </div>
  </div>
</div>

<!-- How It Works Section -->
<div class="lcars-panel">
  <div class="lcars-scan-line"></div>
  <div class="lcars-header">
    <span class="lcars-header-text">How It Works</span>
  </div>
  <div class="lcars-body">
    <div class="row">
      <!-- Left 2/3: Steps -->
      <div class="col-lg-8">

        <!-- Step 1 -->
        <div class="d-flex align-items-start gap-3 mb-3">
          <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0" style="width: 40px; height: 40px; background-color: var(--ss-accent);">
            <span class="text-white fw-bold">1</span>
          </div>
          <div class="pt-1">
            <p class="fw-bold mb-1">Configure Your Search</p>
            <p class="text-muted small mb-0">Enter keywords, set subscriber minimums, and choose filters. Optionally get email notifications.</p>
          </div>
        </div>

        <!-- Connector -->
        <div class="ms-3 border-start border-custom" style="height: 16px; margin-left: 20px !important;"></div>

        <!-- Step 2 -->
        <div class="d-flex align-items-start gap-3 mb-3">
          <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0" style="width: 40px; height: 40px; background-color: var(--ss-accent);">
            <span class="text-white fw-bold">2</span>
          </div>
          <div class="pt-1">
            <p class="fw-bold mb-1">We Query Reddit's API</p>
            <p class="text-muted small mb-0">Our servers fetch fresh data on subreddit names, descriptions, mod activity, and subscriber counts.</p>
          </div>
        </div>

        <!-- Connector -->
        <div class="ms-3 border-start border-custom" style="height: 16px; margin-left: 20px !important;"></div>

        <!-- Step 3 -->
        <div class="d-flex align-items-start gap-3">
          <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0" style="width: 40px; height: 40px; background-color: var(--ss-accent);">
            <span class="text-white fw-bold">3</span>
          </div>
          <div class="pt-1">
            <p class="fw-bold mb-1">Results Join the Database</p>
            <p class="text-muted small mb-0">Download your CSV or browse results online. Every search contributes to our shared public index.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
const RANDOM_SEARCH_INTERVAL = {{ random_search_interval|default:30 }};
let lastSearchEndTime = null;
let countdownInterval = null;

function formatLocalTime(ts) {
  if (!ts) return '—';
  const date = new Date(ts);
  if (Number.isNaN(date.getTime())) return '—';
  return date.toLocaleString('en-US', {
    month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true
  });
}

function refreshLocalTimeElements() {
  document.querySelectorAll('.local-time').forEach(el => {
    const ts = el.getAttribute('data-ts');
    if (ts) el.textContent = formatLocalTime(ts);
  });
}

function formatDuration(startTs, endTs) {
  if (!startTs || !endTs) return '';
  const start = new Date(startTs);
  const end = new Date(endTs);
  if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) return '';
  const diffMs = end - start;
  if (diffMs < 0) return '';
  const seconds = Math.floor(diffMs / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);
  if (hours > 0) {
    return ` · ${hours}h ${minutes % 60}m`;
  } else if (minutes > 0) {
    return ` · ${minutes}m ${seconds % 60}s`;
  } else {
    return ` · ${seconds}s`;
  }
}

function refreshDurationElements() {
  document.querySelectorAll('.duration-display').forEach(el => {
    const started = el.getAttribute('data-started');
    const completed = el.getAttribute('data-completed');
    el.textContent = formatDuration(started, completed);
  });
}

// Countdown timer
function updateCountdown() {
  const countdownEl = document.getElementById('next-search-countdown');
  const countdownRowEl = document.getElementById('countdown-row');
  const currentKeywordEl = document.getElementById('current-keyword');

  // If something is running, hide countdown
  if (currentKeywordEl && currentKeywordEl.textContent !== 'Idle' && currentKeywordEl.textContent !== '—') {
    countdownRowEl.style.display = 'none';
    return;
  }

  countdownRowEl.style.display = 'flex';

  if (!lastSearchEndTime) {
    countdownEl.textContent = `~${RANDOM_SEARCH_INTERVAL} min`;
    return;
  }

  const nextSearchTime = new Date(lastSearchEndTime.getTime() + RANDOM_SEARCH_INTERVAL * 60 * 1000);
  const now = new Date();
  const diffMs = nextSearchTime - now;

  if (diffMs <= 0) {
    countdownEl.textContent = 'any moment...';
  } else {
    const diffMins = Math.floor(diffMs / 60000);
    const diffSecs = Math.floor((diffMs % 60000) / 1000);
    if (diffMins > 0) {
      countdownEl.textContent = `${diffMins}m ${diffSecs}s`;
    } else {
      countdownEl.textContent = `${diffSecs}s`;
    }
  }
}

// Live status updates
async function refreshLiveStatus() {
  try {
    const queueRes = await fetch('/api/queue?limit=10');
    if (queueRes.ok) {
      const data = await queueRes.json();

      // Update "Current Search" section
      const currentKeywordEl = document.getElementById('current-keyword');
      const progressRowEl = document.getElementById('current-progress-row');
      const progressEl = document.getElementById('current-progress');

      if (data.running) {
        currentKeywordEl.textContent = data.running.keyword || 'searching...';
        currentKeywordEl.style.color = 'var(--ss-success)';
        if (data.running.checked > 0 || data.running.found > 0) {
          progressRowEl.style.display = 'flex';
          progressEl.textContent = `${data.running.found} found / ${data.running.checked} checked`;
        }
      } else {
        currentKeywordEl.textContent = 'Idle';
        currentKeywordEl.style.color = 'var(--lcars-tan)';
        progressRowEl.style.display = 'none';
      }

      // Count user (manual) jobs in queue
      const userJobs = (data.queue || []).filter(j => j.is_manual);
      document.getElementById('user-queue-count').textContent =
        userJobs.length > 0 ? `${userJobs.length} waiting` : 'none';

      // Update queue badge and LCARS queue count
      document.getElementById('queue-badge').textContent = `${data.total_queued || 0} pending`;
      const lcarsQueueCount = document.getElementById('lcars-queue-count');
      if (lcarsQueueCount) lcarsQueueCount.textContent = data.total_queued || 0;

      // Render the queue list
      const queueListEl = document.getElementById('queue-list');
      if (data.running || (data.queue && data.queue.length > 0)) {
        let html = '';

        // Show running job first
        if (data.running) {
          const sourceLabel = data.running.is_manual ? 'user' : 'bot';
          html += `
            <div class="list-group-item d-flex align-items-center justify-content-between mb-2 rounded">
              <div>
                <p class="fw-medium small mb-0">"${escapeHtml(data.running.keyword)}"</p>
                <p class="text-muted small mb-0">${data.running.found} found / ${data.running.checked} checked</p>
              </div>
              <span class="badge bg-success">running</span>
            </div>`;
        }

        // Show queued jobs
        (data.queue || []).forEach(job => {
          const sourceLabel = job.is_manual ? 'user' : 'bot';
          const badgeClass = job.is_manual ? 'bg-warning' : 'bg-info';
          html += `
            <div class="list-group-item d-flex align-items-center justify-content-between mb-2 rounded">
              <div>
                <p class="fw-medium small mb-0">"${escapeHtml(job.keyword)}"</p>
                <p class="text-muted small mb-0">${sourceLabel} • limit ${job.limit}</p>
              </div>
              <span class="badge ${badgeClass}">queued</span>
            </div>`;
        });

        queueListEl.innerHTML = html || '<p class="text-muted text-center py-4 mb-0">Queue is empty</p>';
      } else {
        queueListEl.innerHTML = '<p class="text-muted text-center py-4 mb-0">Queue is empty</p>';
      }
    }

    const runsRes = await fetch('/api/recent-runs?limit=5');
    if (runsRes.ok) {
      const data = await runsRes.json();
      if (data.runs) {
        const listEl = document.getElementById('recent-searches-list');
        data.runs.forEach(run => {
          const item = listEl.querySelector(`[data-run-id="${run.job_id}"]`);
          if (item) {
            const badge = item.querySelector('.status-badge');
            const status = run.completed_at ? 'done' : (run.error ? 'error' : 'running');
            if (badge) {
              badge.className = `status-badge badge bg-${status === 'done' ? 'success' : status === 'error' ? 'danger' : 'info'}`;
              badge.textContent = status;
            }
            const count = item.querySelector('.result-count');
            if (count) count.textContent = `${run.result_count || 0} subs`;
          }
        });
      }
    }
  } catch (e) {
    console.error('Status refresh failed:', e);
  }
}

function escapeHtml(s) {
  return s ? String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : '';
}

// Activity filter toggle
document.getElementById('activity_enabled')?.addEventListener('change', function() {
  const mode = document.getElementById('activity_mode');
  const date = document.getElementById('activity_date');
  mode.disabled = !this.checked;
  date.disabled = !this.checked;
  if (!this.checked) { mode.value = 'any'; date.value = ''; }
});

// Fetch last completed search time for countdown
async function fetchLastSearchTime() {
  try {
    const res = await fetch('/api/recent-runs?limit=1&source=random');
    if (res.ok) {
      const data = await res.json();
      if (data.runs && data.runs.length > 0 && data.runs[0].completed_at) {
        lastSearchEndTime = new Date(data.runs[0].completed_at);
      }
    }
  } catch (e) {
    console.error('Failed to fetch last search time:', e);
  }
}

// Format stats updated time (relative)
function formatStatsUpdatedTime() {
  const el = document.getElementById('stats-updated-at');
  if (!el) return;
  const ts = el.getAttribute('data-ts');
  if (!ts) {
    el.textContent = '';
    return;
  }
  const date = new Date(ts);
  if (Number.isNaN(date.getTime())) {
    el.textContent = '';
    return;
  }
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  if (diffMins < 1) {
    el.textContent = 'Updated just now';
  } else if (diffMins < 60) {
    el.textContent = `Updated ${diffMins}m ago`;
  } else {
    const diffHours = Math.floor(diffMins / 60);
    el.textContent = `Updated ${diffHours}h ago`;
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', async () => {
  refreshLocalTimeElements();
  refreshDurationElements();
  formatStatsUpdatedTime();
  await fetchLastSearchTime();
  refreshLiveStatus();
  updateCountdown();

  setInterval(refreshLiveStatus, 3000);
  countdownInterval = setInterval(updateCountdown, 1000);
  setInterval(formatStatsUpdatedTime, 60000); // Update relative time every minute
});
</script>
{% endblock %}
