{% extends "base.html" %}
{% load static %}
{% block title %}Sub Search - Reddit Subreddit Discovery{% endblock %}

{% block content %}
<!-- Hero Section with Stats -->
<section class="panel p-6 sm:p-8 mb-8">
  <div class="text-center max-w-3xl mx-auto">
    <h1 class="text-3xl sm:text-4xl lg:text-5xl font-black">
      Discover <span class="text-sub-green-light">Reddit</span> Subreddits
    </h1>
    <p class="mt-4 text-gray-400 text-lg">
      Search, filter, and export subreddit data. Every search adds to our growing community database.
    </p>
  </div>

  <!-- Stats Row -->
  <div class="mt-8 grid grid-cols-2 sm:grid-cols-4 gap-4">
    <div class="card p-4 text-center">
      <p class="stat-label">Subs Indexed</p>
      <p class="stat-value text-sub-green-light">{{ stats.total_subreddits|default:0 }}</p>
    </div>
    <div class="card p-4 text-center">
      <p class="stat-label">Total Searches</p>
      <p class="stat-value">{{ stats.total_runs|default:0 }}</p>
    </div>
    <div class="card p-4 text-center">
      <p class="stat-label">In Queue</p>
      <p class="stat-value text-sub-yellow">{{ queue_count|default:0 }}</p>
    </div>
    <div class="card p-4 text-center">
      <p class="stat-label">Last Search</p>
      <p class="text-sm text-gray-300 local-time" data-ts="{{ stats.last_run_started|date:'c' }}">{{ stats.last_run_started|date:"M d, H:i"|default:"—" }}</p>
    </div>
  </div>
</section>

<!-- Main Grid: Search + Sidebar -->
<div class="grid gap-6 lg:grid-cols-3">
  <!-- Left Column: Search Form -->
  <div class="lg:col-span-2 space-y-6">
    <!-- Search Form Card -->
    <div class="panel p-6">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-10 h-10 rounded-xl bg-sub-green/20 flex items-center justify-center">
          <svg class="w-5 h-5 text-sub-green-light" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
        </div>
        <div>
          <h2 class="text-xl font-bold">New Search</h2>
          <p class="text-sm text-muted">Find subreddits matching your criteria</p>
        </div>
      </div>

      <form method="post" action="{% url 'home' %}" id="run-form">
        {% csrf_token %}

        <div class="grid gap-4 sm:grid-cols-2">
          <div>
            <label for="keyword">Keyword Filter</label>
            <input type="text" id="keyword" name="keyword" placeholder="e.g. gaming, crypto, cooking" maxlength="64" pattern="[A-Za-z0-9 _\-]*">
            <p class="form-help">Search for subs containing this word</p>
          </div>
          <div>
            <label for="limit">Max Subs to Check</label>
            <input type="text" id="limit" name="limit" inputmode="numeric" pattern="[0-9,]*" value="1,000">
            <p class="form-help">Higher = more results, longer wait</p>
          </div>
          <div>
            <label for="min_subs">Minimum Subscribers</label>
            <input type="text" id="min_subs" name="min_subs" inputmode="numeric" pattern="[0-9,]*" value="0">
          </div>
          <div>
            <label for="notification_email">Email When Done (optional)</label>
            <input type="email" id="notification_email" name="notification_email" placeholder="you@example.com">
          </div>
        </div>

        <!-- Filter Options -->
        <div class="mt-6 grid gap-4 sm:grid-cols-2">
          <div class="card p-4">
            <p class="text-sm font-semibold text-gray-300 mb-3">Content Filters</p>
            <label class="flex items-center gap-3 cursor-pointer mb-2">
              <input type="checkbox" id="unmoderated_only" name="unmoderated_only">
              <span class="text-sm">Only unmoderated subs</span>
            </label>
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="exclude_nsfw" name="exclude_nsfw">
              <span class="text-sm">Exclude NSFW</span>
            </label>
          </div>
          <div class="card p-4">
            <label class="flex items-center gap-3 cursor-pointer mb-3">
              <input type="checkbox" id="activity_enabled" name="activity_enabled">
              <span class="text-sm font-semibold">Filter by mod activity</span>
            </label>
            <div class="grid grid-cols-2 gap-2">
              <select id="activity_mode" name="activity_mode" class="text-sm" disabled>
                <option value="any">Any activity</option>
                <option value="active_after">Active since</option>
                <option value="inactive_before">Inactive since</option>
              </select>
              <input type="date" id="activity_date" name="activity_date" class="text-sm" disabled>
            </div>
          </div>
        </div>

        <button type="submit" class="btn-primary w-full mt-6 py-4 text-lg font-bold">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          Start Search
        </button>
      </form>

      <!-- Job Status Panel -->
      <div id="run-state" class="mt-6 card p-5 border-sub-green/30 {% if not job_id %}hidden{% endif %}">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div class="flex items-center gap-4">
            <div class="loader" id="status-loader"></div>
            <div>
              <p id="status-title" class="font-bold text-lg">Preparing search...</p>
              <p id="status-sub" class="text-sm text-muted">—</p>
            </div>
          </div>
          <div class="flex items-center gap-6">
            <div class="text-center">
              <p class="stat-label">Checked</p>
              <p id="checked" class="text-xl font-bold">0</p>
            </div>
            <div class="text-center">
              <p class="stat-label">Found</p>
              <p id="found" class="text-xl font-bold text-sub-green-light">0</p>
            </div>
            <div class="text-center">
              <p class="stat-label">Limit</p>
              <p id="limit_count" class="text-xl font-bold text-muted">0</p>
            </div>
            <button id="stopBtn" class="btn-danger text-sm">Stop</button>
          </div>
        </div>
      </div>

      <!-- Results Panel -->
      <div id="results-panel" class="mt-6 card p-5 border-sub-green/30 hidden">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div>
            <h3 id="results-title" class="text-xl font-bold text-sub-green-light">Results Ready!</h3>
            <p id="results-subtitle" class="text-sm text-muted">Your search is complete</p>
          </div>
          <div class="flex gap-3">
            <a id="download-btn" href="#" class="btn-secondary pointer-events-none opacity-50">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
              </svg>
              Download CSV
            </a>
            <a id="view-all-btn" href="#" class="btn-primary pointer-events-none opacity-50">View Results</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Searches Card -->
    <div class="panel p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-sub-yellow/20 flex items-center justify-center">
            <svg class="w-5 h-5 text-sub-yellow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <h2 class="text-xl font-bold">Recent Searches</h2>
        </div>
        <a href="{% url 'logs' %}" class="btn-ghost text-sm">View All</a>
      </div>

      <div class="space-y-3" id="recent-searches-list">
        {% if recent_user_runs %}
        {% for run in recent_user_runs %}
        <div class="card-hover p-4" data-run-id="{{ run.job_id }}">
          <div class="flex items-center justify-between">
            <div>
              <p class="font-semibold">{{ run.keyword|default:"All subreddits" }}</p>
              <p class="text-xs text-muted mt-1">
                <span class="result-count">{{ run.result_count|default:0 }} subs</span> &middot;
                <span class="local-time" data-ts="{{ run.started_at|date:'c' }}">{{ run.started_at|date:"M d, H:i"|default:"—" }}</span>
              </p>
            </div>
            <span class="status-badge badge {% if run.completed_at %}badge-success{% elif run.error %}badge-error{% else %}badge-info{% endif %}">
              {% if run.completed_at %}done{% elif run.error %}error{% else %}running{% endif %}
            </span>
          </div>
        </div>
        {% endfor %}
        {% else %}
        <p class="text-muted text-sm py-4 text-center">No searches yet. Start your first search above!</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Right Column: Sidebar Cards -->
  <div class="space-y-6">
    <!-- Live Status Card -->
    <div class="panel p-5">
      <p class="section-label mb-4">Live Status</p>

      <!-- Currently Running -->
      <div class="card p-4 mb-3 border-sub-green/30">
        <div class="flex items-center gap-2 mb-2">
          <span class="w-2 h-2 bg-sub-green-light rounded-full animate-pulse"></span>
          <span class="text-xs font-semibold uppercase text-sub-green-light">Now Running</span>
        </div>
        <p class="font-bold" id="current-keyword">—</p>
        <p class="text-xs text-muted mt-1">
          <span id="current-checked">0</span> checked / <span id="current-found">0</span> found
        </p>
      </div>

      <!-- On Deck -->
      <div class="card p-4 mb-3">
        <div class="flex items-center gap-2 mb-2">
          <span class="w-2 h-2 bg-sub-yellow rounded-full"></span>
          <span class="text-xs font-semibold uppercase text-sub-yellow">Next Up</span>
        </div>
        <p class="font-semibold" id="ondeck-keyword">—</p>
        <p class="text-xs text-muted mt-1">ETA: <span id="ondeck-eta">—</span></p>
      </div>

      <!-- Last Completed -->
      <div class="card p-4">
        <div class="flex items-center gap-2 mb-2">
          <span class="w-2 h-2 bg-gray-500 rounded-full"></span>
          <span class="text-xs font-semibold uppercase text-gray-400">Last Complete</span>
        </div>
        <p class="font-semibold" id="last-keyword">—</p>
        <p class="text-xs text-muted mt-1"><span id="last-results">0</span> subs found</p>
      </div>
    </div>

    <!-- Quick Links Card -->
    <div class="panel p-5">
      <p class="section-label mb-4">Quick Links</p>
      <div class="space-y-2">
        <a href="{% url 'all_subs' %}" class="card-hover p-4 flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-sub-green/20 flex items-center justify-center">
            <svg class="w-5 h-5 text-sub-green-light" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
            </svg>
          </div>
          <div>
            <p class="font-semibold">Browse All Subs</p>
            <p class="text-xs text-muted">Explore {{ stats.total_subreddits|default:"200K+" }} indexed subreddits</p>
          </div>
        </a>
        <a href="{% url 'nodes_home' %}" class="card-hover p-4 flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-sub-yellow/20 flex items-center justify-center">
            <svg class="w-5 h-5 text-sub-yellow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.636 18.364a9 9 0 010-12.728m12.728 0a9 9 0 010 12.728m-9.9-2.829a5 5 0 010-7.07m7.072 0a5 5 0 010 7.07M13 12a1 1 0 11-2 0 1 1 0 012 0z"/>
            </svg>
          </div>
          <div>
            <p class="font-semibold">Volunteer Nodes</p>
            <p class="text-xs text-muted">Help grow the database</p>
          </div>
        </a>
      </div>
    </div>

    <!-- Auto Bot Card -->
    <div class="panel p-5">
      <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 rounded-xl bg-blue-900/30 flex items-center justify-center">
          <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
          </svg>
        </div>
        <div>
          <p class="font-bold">Auto Search Bot</p>
          <p class="text-xs text-blue-400">Always searching</p>
        </div>
      </div>
      {% if random_run %}
      <div class="card p-3">
        <p class="text-sm">Keyword: <span class="font-semibold text-white">{{ random_run.keyword|default:"random" }}</span></p>
        <p class="text-xs text-muted mt-1">{{ random_run.result_count|default:0 }} subs collected</p>
      </div>
      {% else %}
      <p class="text-sm text-muted">Bot is idle...</p>
      {% endif %}
      <p class="text-xs text-gray-500 mt-3">Auto-search every {{ random_search_interval }} minutes</p>
    </div>
  </div>
</div>

<!-- Bottom: How It Works -->
<section class="mt-8 panel p-6">
  <div class="flex items-center gap-3 mb-6">
    <div class="w-10 h-10 rounded-xl bg-sub-green/20 flex items-center justify-center">
      <svg class="w-5 h-5 text-sub-green-light" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
      </svg>
    </div>
    <h2 class="text-xl font-bold">How It Works</h2>
  </div>

  <div class="grid gap-6 sm:grid-cols-3">
    <div class="flex gap-4">
      <div class="flex-shrink-0 w-10 h-10 rounded-full bg-sub-green flex items-center justify-center text-white font-bold">1</div>
      <div>
        <p class="font-semibold">Configure Your Search</p>
        <p class="text-sm text-muted mt-1">Enter keywords, set filters, and choose how many subs to check.</p>
      </div>
    </div>
    <div class="flex gap-4">
      <div class="flex-shrink-0 w-10 h-10 rounded-full bg-sub-green flex items-center justify-center text-white font-bold">2</div>
      <div>
        <p class="font-semibold">We Query Reddit's API</p>
        <p class="text-sm text-muted mt-1">Fresh data on names, mods, activity, and subscriber counts.</p>
      </div>
    </div>
    <div class="flex gap-4">
      <div class="flex-shrink-0 w-10 h-10 rounded-full bg-sub-green flex items-center justify-center text-white font-bold">3</div>
      <div>
        <p class="font-semibold">Results Added to Database</p>
        <p class="text-sm text-muted mt-1">Every search contributes to the shared public directory.</p>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

function formatLocalTime(ts) {
  if (!ts) return '—';
  const date = new Date(ts);
  if (Number.isNaN(date.getTime())) return '—';
  return date.toLocaleString('en-US', {
    month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true
  });
}

function formatETA(seconds) {
  if (!seconds || seconds < 0) return '—';
  if (seconds < 60) return `${seconds}s`;
  const minutes = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return secs > 0 ? `${minutes}m ${secs}s` : `${minutes}m`;
}

function refreshLocalTimeElements() {
  document.querySelectorAll('.local-time').forEach(el => {
    const ts = el.getAttribute('data-ts');
    if (ts) el.textContent = formatLocalTime(ts);
  });
}

// Live status updates
async function refreshLiveStatus() {
  try {
    const queueRes = await fetch('/api/queue?limit=5');
    if (queueRes.ok) {
      const data = await queueRes.json();

      // Currently running
      if (data.running) {
        document.getElementById('current-keyword').textContent = data.running.keyword || 'All subs';
        document.getElementById('current-checked').textContent = (data.running.checked || 0).toLocaleString();
        document.getElementById('current-found').textContent = (data.running.found || 0).toLocaleString();
      } else {
        document.getElementById('current-keyword').textContent = 'Idle';
        document.getElementById('current-checked').textContent = '—';
        document.getElementById('current-found').textContent = '—';
      }

      // On deck
      if (data.queue && data.queue.length > 0) {
        const next = data.queue[0];
        document.getElementById('ondeck-keyword').textContent = next.keyword || 'All subs';
        document.getElementById('ondeck-eta').textContent = formatETA(next.eta_start_seconds);
      } else {
        document.getElementById('ondeck-keyword').textContent = 'Queue empty';
        document.getElementById('ondeck-eta').textContent = '—';
      }
    }

    const runsRes = await fetch('/api/recent-runs?limit=5');
    if (runsRes.ok) {
      const data = await runsRes.json();
      if (data.runs && data.runs.length > 0) {
        const completed = data.runs.find(r => r.completed_at);
        if (completed) {
          document.getElementById('last-keyword').textContent = completed.keyword || 'All subs';
          document.getElementById('last-results').textContent = (completed.result_count || 0).toLocaleString();
        }

        const listEl = document.getElementById('recent-searches-list');
        data.runs.forEach(run => {
          const item = listEl.querySelector(`[data-run-id="${run.job_id}"]`);
          if (item) {
            const badge = item.querySelector('.status-badge');
            const status = run.completed_at ? 'done' : (run.error ? 'error' : 'running');
            if (badge) {
              badge.className = `status-badge badge badge-${status === 'done' ? 'success' : status === 'error' ? 'error' : 'info'}`;
              badge.textContent = status;
            }
            const count = item.querySelector('.result-count');
            if (count) count.textContent = `${run.result_count || 0} subs`;
          }
        });
      }
    }
  } catch (e) {
    console.error('Status refresh failed:', e);
  }
}

// Job polling
const jobIdFromServer = {% if job_id %}"{{ job_id }}"{% else %}null{% endif %};
let pollTimer = null;
let activeJobId = jobIdFromServer;

async function fetchStatus(id) {
  try {
    const res = await fetch(`/status/${id}/`);
    if (!res.ok) return;
    const data = await res.json();
    if (!data) return;
    updateStatusUi(data);
    if (data.done && pollTimer) {
      clearInterval(pollTimer);
      pollTimer = null;
    }
  } catch (e) { console.error(e); }
}

function updateStatusUi(data) {
  const limit = Number(data.limit || data.job_config?.limit || 0);
  const checked = Number(data.checked || 0);
  const found = Number(data.found || 0);

  document.getElementById('limit_count').textContent = limit.toLocaleString();
  document.getElementById('checked').textContent = checked.toLocaleString();
  document.getElementById('found').textContent = found.toLocaleString();

  const state = data.state || (data.done ? 'complete' : 'running');
  const statusTitle = document.getElementById('status-title');
  const statusSub = document.getElementById('status-sub');

  if (state === 'queued') {
    statusTitle.textContent = 'In the queue...';
    statusSub.textContent = 'Waiting for your turn';
  } else if (state === 'running') {
    statusTitle.textContent = 'Searching...';
    statusSub.textContent = `Keyword: "${data.keyword || 'all'}"`;
  } else if (state === 'error') {
    statusTitle.textContent = 'Search failed';
    statusSub.textContent = data.error || 'Unknown error';
  } else {
    statusTitle.textContent = state === 'stopped' ? 'Search cancelled' : 'Search complete!';
    statusSub.textContent = data.error || 'Results are ready';
  }

  document.getElementById('stopBtn').disabled = !!data.done;

  if (data.done && data.results_ready) {
    document.getElementById('run-state').classList.add('hidden');
    document.getElementById('results-panel').classList.remove('hidden');
    const total = Number(data.result_count || found);
    document.getElementById('results-title').textContent = `${total.toLocaleString()} subs found!`;
    document.getElementById('results-subtitle').textContent = 'Your search is complete';
    const dlBtn = document.getElementById('download-btn');
    const viewBtn = document.getElementById('view-all-btn');
    dlBtn.href = `/job/${activeJobId}/download.csv`;
    dlBtn.classList.remove('pointer-events-none', 'opacity-50');
    viewBtn.href = `/all-the-subs/?job_id=${encodeURIComponent(activeJobId)}`;
    viewBtn.classList.remove('pointer-events-none', 'opacity-50');
  }
}

// Activity filter toggle
document.getElementById('activity_enabled')?.addEventListener('change', function() {
  const mode = document.getElementById('activity_mode');
  const date = document.getElementById('activity_date');
  mode.disabled = !this.checked;
  date.disabled = !this.checked;
  if (!this.checked) { mode.value = 'any'; date.value = ''; }
});

// Stop button
document.getElementById('stopBtn')?.addEventListener('click', async function() {
  if (!activeJobId) return;
  try {
    const res = await fetch(`/stop/${activeJobId}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/json' }
    });
    if (res.ok) {
      if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
      fetchStatus(activeJobId);
    }
  } catch (e) { console.error(e); }
});

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  refreshLocalTimeElements();
  refreshLiveStatus();
  setInterval(refreshLiveStatus, 3000);

  if (activeJobId) {
    document.getElementById('run-state').classList.remove('hidden');
    fetchStatus(activeJobId);
    pollTimer = setInterval(() => fetchStatus(activeJobId), 1000);
  }
});
</script>
{% endblock %}
