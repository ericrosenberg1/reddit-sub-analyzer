{% extends "base.html" %}
{% load static %}
{% block title %}Eric Rosenberg Sub Search{% endblock %}

{% block content %}
<section class="panel-surface overflow-hidden p-6 shadow-2xl lg:p-10">
  <div class="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
    <div class="max-w-3xl space-y-4">
      <p class="text-sm font-semibold uppercase tracking-[0.4em] text-white/60">An <a href="https://ericrosenberg.com">Eric Rosenberg</a> project</p>
      <h1 class="font-display text-4xl text-white sm:text-5xl">Sub Search + All The Subs</h1>
      <p class="text-lg text-white/80">Sub Search keeps a living index of subreddit names, descriptions, moderator counts, and last human moderator activity so you can analyze communities and export targeted lists. With more than 3 million subs, this is a community-driven effort to maintain an updated database.</p>
      <div class="mt-6 flex flex-wrap gap-3">
        <a href="{% url 'all_subs' %}" class="nav-link text-sm">Browse All The Subs</a>
        <a href="https://github.com/ericrosenberg1/reddit-sub-analyzer" target="_blank" rel="noopener" class="nav-link text-sm">View on GitHub</a>
      </div>
    </div>
    <div class="flex flex-col gap-4 lg:max-w-sm">
      <img src="{% static 'img/sub-sando-hero.svg' %}" alt="Sub Search hero illustration" class="hero-art w-full rounded-3xl border border-white/10 bg-slate-900/40 p-3">
      <div class="rounded-3xl border border-white/10 bg-slate-900/50 p-6 text-sm text-white/70 shadow-lg">
        <p class="text-xs uppercase tracking-[0.3em] text-white/50">Data health</p>
        <ul class="mt-4 space-y-3">
          <li class="flex items-center justify-between">
            <span>Total subreddits indexed</span>
            <span class="text-lg font-semibold text-white">{{ stats.total_subreddits|default:0 }}</span>
          </li>
          <li class="flex items-center justify-between">
            <span>Total Sub Searches</span>
            <span class="text-lg font-semibold text-white">{{ stats.total_runs|default:0 }}</span>
          </li>
          <li class="flex items-center justify-between">
            <span>Searches in queue</span>
            <span class="text-lg font-semibold text-sky-300">{{ queue_count|default:0 }}</span>
          </li>
          <li class="flex flex-col gap-1">
            <span>Last indexed</span>
            <span class="local-time text-sm text-white/90" data-ts="{{ stats.last_indexed|date:'c' }}">{{ stats.last_indexed|date:"Y-m-d H:i T"|default:"pending" }}</span>
          </li>
          <li class="flex flex-col gap-1">
            <span>Last search started</span>
            <span class="local-time text-sm text-white/90" data-ts="{{ stats.last_run_started|date:'c' }}">{{ stats.last_run_started|date:"Y-m-d H:i T"|default:"pending" }}</span>
          </li>
        </ul>
      </div>
    </div>
  </div>
</section>

<section class="panel-surface mt-10 p-6 shadow-2xl lg:p-10">
  <h2 class="mb-6 text-2xl font-semibold text-white">Sub Search</h2>
  <form method="post" action="{% url 'home' %}" id="run-form" class="grid gap-6 lg:grid-cols-2">
    {% csrf_token %}
    <div class="space-y-4">
      <div>
        <label for="keyword" class="text-sm font-semibold text-white/90">Subreddit name contains</label>
        <input type="text" id="keyword" name="keyword" placeholder="e.g. fintech, outdoor, language" maxlength="64" pattern="[A-Za-z0-9 _\-]*" class="mt-2 w-full rounded-xl border border-white/10 bg-slate-900/80 px-4 py-3 text-white placeholder:text-white/30 focus:border-brand focus:ring-2 focus:ring-brand/40" />
      </div>
      <div>
        <label for="limit" class="text-sm font-semibold text-white/90">Max subreddits to check</label>
        <input type="text" id="limit" name="limit" inputmode="numeric" pattern="[0-9,]*" value="1,000" class="mt-2 w-full rounded-xl border border-white/10 bg-slate-900/80 px-4 py-3 text-white placeholder:text-white/30 focus:border-brand focus:ring-2 focus:ring-brand/40" />
      </div>
      <div>
        <label for="min_subs" class="text-sm font-semibold text-white/90">Minimum subscribers</label>
        <input type="text" id="min_subs" name="min_subs" inputmode="numeric" pattern="[0-9,]*" value="0" class="mt-2 w-full rounded-xl border border-white/10 bg-slate-900/80 px-4 py-3 text-white placeholder:text-white/30 focus:border-brand focus:ring-2 focus:ring-brand/40" />
      </div>
      <div>
        <label for="notification_email" class="text-sm font-semibold text-white/90">Email me when done (optional)</label>
        <input type="email" id="notification_email" name="notification_email" placeholder="you@example.com" class="mt-2 w-full rounded-xl border border-white/10 bg-slate-900/80 px-4 py-3 text-white placeholder:text-white/30 focus:border-brand focus:ring-2 focus:ring-brand/40" />
        <p class="mt-1 text-xs text-white/50">Get notified with a link to your results</p>
      </div>
    </div>
    <div class="space-y-4">
      <div class="rounded-xl border border-white/10 bg-slate-900/50 p-4">
        <label class="flex items-center gap-3 text-sm font-semibold text-white/90">
          <input type="checkbox" id="unmoderated_only" name="unmoderated_only" class="rounded border-white/20 bg-slate-900 text-brand focus:ring-brand/60" />
          Only show unmoderated subreddits
        </label>
        <label class="mt-3 flex items-center gap-3 text-sm font-semibold text-white/90">
          <input type="checkbox" id="exclude_nsfw" name="exclude_nsfw" class="rounded border-white/20 bg-slate-900 text-brand focus:ring-brand/60" />
          Exclude NSFW subreddits
        </label>
      </div>
      <div class="rounded-xl border border-white/10 bg-slate-900/50 p-4">
        <label class="flex items-center gap-3 text-sm font-semibold text-white/90">
          <input type="checkbox" id="activity_enabled" name="activity_enabled" class="rounded border-white/20 bg-slate-900 text-brand focus:ring-brand/60" />
          Enable activity filter
        </label>
        <div class="mt-3 grid gap-3 sm:grid-cols-2">
          <div>
            <label for="activity_mode" class="text-xs uppercase tracking-[0.2em] text-white/50">Mode</label>
            <select id="activity_mode" name="activity_mode" disabled class="mt-1 w-full rounded-xl border border-white/10 bg-slate-900/80 px-3 py-2 text-sm text-white focus:border-brand focus:ring-brand/50">
              <option value="any">Any activity</option>
              <option value="active_after">Active since date</option>
              <option value="inactive_before">Inactive since date</option>
            </select>
          </div>
          <div>
            <label for="activity_date" class="text-xs uppercase tracking-[0.2em] text-white/50">Date</label>
            <input type="date" id="activity_date" name="activity_date" disabled class="mt-1 w-full rounded-xl border border-white/10 bg-slate-900/80 px-3 py-2 text-sm text-white focus:border-brand focus:ring-brand/50" />
          </div>
        </div>
      </div>
    </div>
    <div class="lg:col-span-2">
      <button type="submit" class="flex w-full items-center justify-center rounded-2xl bg-gradient-to-r from-brand to-brand-light px-6 py-4 text-lg font-semibold text-slate-950 shadow-brand transition hover:scale-[1.01] focus:outline-none focus:ring-2 focus:ring-brand-light/60">Find Your Subs</button>
    </div>
  </form>


  <div id="run-state" class="mb-6 {% if not job_id %}hidden{% endif %} rounded-2xl border border-white/5 bg-slate-900/70 p-6">
    <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
      <div class="flex flex-col gap-3">
        <div class="flex items-center gap-4">
          <div class="loader" id="status-loader"></div>
          <div>
            <p id="status-title" class="text-lg font-semibold text-white">Waiting for the sandwich counter...</p>
            <p id="status-sub" class="text-sm text-white/70">‚Äî</p>
          </div>
        </div>
        <p id="queue-orders" class="hidden text-sm text-white/60">Orders ahead: 0</p>
        <p id="queue-eta" class="hidden text-sm text-white/50">‚Äî</p>
        <span id="queue-chip" class="hidden w-fit rounded-full border border-white/20 px-3 py-1 text-xs uppercase tracking-[0.3em] text-white/70"></span>
      </div>
      <div class="flex flex-col items-end gap-3">
        <div class="grid grid-cols-3 gap-4 rounded-xl border border-white/10 bg-slate-900/60 p-4 text-center">
          <div><p class="text-xs uppercase tracking-[0.2em] text-white/50">Checked</p><p id="checked" class="text-2xl font-bold text-white">0</p></div>
          <div><p class="text-xs uppercase tracking-[0.2em] text-white/50">Found</p><p id="found" class="text-2xl font-bold text-brand">0</p></div>
          <div><p class="text-xs uppercase tracking-[0.2em] text-white/50">Limit</p><p id="limit_count" class="text-2xl font-bold text-white/70">0</p></div>
        </div>
        <button id="stopBtn" class="rounded-xl bg-red-500/20 px-4 py-2 text-sm font-semibold text-red-200 transition hover:bg-red-500/30">Stop Search</button>
      </div>
    </div>
  </div>

  <div id="results-panel" class="mb-6 hidden rounded-2xl border border-white/5 bg-slate-900/70 p-6">
    <div class="mb-4 flex flex-wrap items-center justify-between gap-4">
      <div>
        <h3 id="results-title" class="text-2xl font-semibold text-white">Results</h3>
        <p id="results-subtitle" class="text-sm text-white/70">‚Äî</p>
      </div>
      <div class="flex gap-3">
        <a id="download-btn" href="#" class="rounded-xl bg-brand/20 px-4 py-2 text-sm font-semibold text-brand transition hover:bg-brand/30 pointer-events-none opacity-50">Download CSV</a>
        <a id="view-all-btn" href="#" class="rounded-xl bg-brand/20 px-4 py-2 text-sm font-semibold text-brand transition hover:bg-brand/30 pointer-events-none opacity-50">View in All The Subs</a>
      </div>
    </div>
    <div class="overflow-x-auto">
      <table id="results-table" class="w-full text-sm">
        <thead class="border-b border-white/10 text-left text-xs uppercase tracking-[0.2em] text-white/60">
          <tr>
            <th class="cursor-pointer px-4 py-3 hover:text-white" data-sort="name">Subreddit ‚Üï</th>
            <th class="cursor-pointer px-4 py-3 hover:text-white" data-sort="subscribers">Subscribers ‚Üï</th>
            <th class="cursor-pointer px-4 py-3 hover:text-white" data-sort="created_utc">Created ‚Üï</th>
            <th class="cursor-pointer px-4 py-3 hover:text-white" data-sort="last_human_mod_activity_utc">Last Mod Activity ‚Üï</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-white/5"></tbody>
      </table>
    </div>
</section>

<section class="panel-surface mt-10 p-6 shadow-xl">
  <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
    <div>
      <p class="text-xs uppercase tracking-[0.3em] text-white/60">Always Preparing Fresh Ingredients</p>
      <h2 class="text-2xl font-semibold text-white">The Sub Builder Bot</h2>
      {% if random_run %}
      <p class="mt-2 text-sm text-white/80">
        Keyword <span class="font-semibold text-white">{{ random_run.keyword|default:"‚Äî" }}</span> ‚Ä¢ Limit {{ random_run.limit_value|default:"2000" }}
        ‚Ä¢ <span class="local-time" data-ts="{{ random_run.started_at|date:'c' }}"></span>
      </p>
      <p class="mt-1 text-xs text-white/60">{{ random_run.result_count|default:0 }} total subs collected</p>
      {% if random_run.error %}
      <p class="text-xs text-red-300">Error: {{ random_run.error }}</p>
      {% endif %}
      {% if random_run.job_id %}
      <div class="mt-3 flex flex-wrap gap-3 text-xs">
        <a class="nav-link text-xs" href="{% url 'all_subs' %}?job_id={{ random_run.job_id }}">View in All The Subs</a>
      </div>
      {% endif %}
      {% else %}
      <p class="mt-2 text-sm text-white/80">Searching for subs...</p>
      {% endif %}
    </div>
    <div class="text-xs uppercase tracking-[0.3em] text-white/60">
      This bot is hungry. <br />
      New Sub Search every {{ random_search_interval }} minutes
    </div>
  </div>
</section>

<div class="panel-surface mt-10 p-6 shadow-xl" id="queue-status-section" style="display: none;">
  <div class="flex items-center justify-between">
    <div>
      <p class="text-xs uppercase tracking-[0.3em] text-white/60">Search Queue</p>
      <h2 class="text-2xl font-semibold text-white">Next <span id="queue-count-display">10</span> Searches</h2>
    </div>
    <span class="text-sm text-white/70"><span id="total-queued">0</span> queued ‚Ä¢ <span id="running-count">0</span> running</span>
  </div>

  <div class="mt-6" id="queue-list">
    <!-- Queue items will be inserted here -->
  </div>

  <p class="mt-4 text-xs text-white/60">Manual user searches are prioritized above automated searches</p>
</div>

<div class="mt-10 grid gap-4 md:grid-cols-3">
  <article class="rounded-3xl border border-white/10 bg-slate-900/40 p-5 shadow-lg">
    <p class="text-xs uppercase tracking-[0.3em] text-white/60">Always growing</p>
    <h3 class="mt-2 text-xl font-semibold text-white">Automatic database expansion</h3>
    <p class="mt-2 text-sm text-white/80">Every search is saved in the public database, and random subreddits are added automatically.</p>
  </article>
  <article class="rounded-3xl border border-white/10 bg-slate-900/40 p-5 shadow-lg">
    <p class="text-xs uppercase tracking-[0.3em] text-white/60">Community powered</p>
    <h3 class="mt-2 text-xl font-semibold text-white">Distributed node network</h3>
    <p class="mt-2 text-sm text-white/80">Anyone can run a node that feeds the main database, fueling faster growth and fresher results.</p>
  </article>
  <article class="rounded-3xl border border-white/10 bg-slate-900/40 p-5 shadow-lg">
    <p class="text-xs uppercase tracking-[0.3em] text-white/60">One search at a time</p>
    <h3 class="mt-2 text-xl font-semibold text-white">Queued search processing</h3>
    <p class="mt-2 text-sm text-white/80">Only one search runs at a time to protect Reddit's API limits. Others wait in queue with real-time ETA updates.</p>
  </article>
</div>

<section class="mt-10 grid gap-8 lg:grid-cols-2">
  <div class="panel-surface p-6 shadow-xl">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-xs uppercase tracking-[0.3em] text-white/60">Activity</p>
        <h2 class="text-2xl font-semibold text-white">Recent Sub Searches</h2>
      </div>
      <a href="{% url 'home' %}" class="nav-link text-sm">Find Your Subs ‚Üí</a>
    </div>
    <ul class="mt-6 space-y-4" id="recent-searches-list">
      {% if recent_user_runs %}
      {% for run in recent_user_runs %}
      <li class="rounded-2xl border border-white/10 bg-slate-900/50 p-4" data-run-id="{{ run.job_id }}">
        <div class="flex flex-wrap items-center justify-between gap-2">
          <div class="flex flex-col">
            <span class="text-base font-semibold text-white">{{ run.keyword|default:"All subreddits" }}</span>
            <span class="local-time text-xs text-white/60" data-ts="{{ run.started_at|date:'c' }}">{{ run.started_at|date:"Y-m-d H:i T"|default:"‚Äî" }}</span>
          </div>
          <span class="status-badge rounded-full px-3 py-1 text-xs font-semibold uppercase tracking-[0.2em] {% if run.completed_at %}bg-emerald-500/15 text-emerald-200{% elif run.error %}bg-red-500/15 text-red-200{% else %}bg-sky-500/15 text-sky-200{% endif %}">
            {% if run.completed_at %}complete{% elif run.error %}error{% else %}running{% endif %}
          </span>
        </div>
        <div class="mt-3 flex flex-wrap items-center gap-3 text-xs text-white/60">
          <span class="result-count">{{ run.result_count|default:0 }} subs</span>
          <span>Source: {{ run.source }}</span>
          {% if run.error %}<span class="text-red-300">Error: {{ run.error }}</span>{% endif %}
        </div>
      </li>
      {% endfor %}
      {% else %}
      <p class="text-white/70">No Sub Searches logged yet. Be the first to generate data!</p>
      {% endif %}
    </ul>
  </div>

  <div class="panel-surface p-6 shadow-xl">
    <p class="text-xs uppercase tracking-[0.3em] text-white/60">Pipeline</p>
    <h2 class="text-2xl font-semibold text-white">How the sandwich is made</h2>
    <ol class="mt-4 space-y-4 text-sm text-white/80">
      <li class="flex gap-3">
        <span class="rounded-full bg-brand/30 px-3 py-1 font-semibold text-brand">1</span>
        <div>
          <p class="font-semibold text-white">Manual Sub Searches</p>
          <p>Every time you run Sub Search, we capture names, descriptions, moderator counts, and last mod activity for anything that matches your filters.</p>
        </div>
      </li>
      <li class="flex gap-3">
        <span class="rounded-full bg-brand/30 px-3 py-1 font-semibold text-brand">2</span>
        <div>
          <p class="font-semibold text-white">Auto-ingest bot + volunteer nodes</p>
          <p>A paced background bot‚Äîand now opt-in community nodes‚Äîsweep scheduled keywords so fresh subs show up even when nobody is at the keyboard.</p>
        </div>
      </li>
      <li class="flex gap-3">
        <span class="rounded-full bg-brand/30 px-3 py-1 font-semibold text-brand">3</span>
        <div>
          <p class="font-semibold text-white">Shared dataset</p>
          <p>Results flow into the same directory that powers Sub Search exports and All The Subs, keeping everything in sync without extra clicks.</p>
        </div>
      </li>
    </ol>
    <div class="mt-6 rounded-2xl border border-white/10 bg-slate-900/40 p-4">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <p class="text-sm font-semibold text-white">Search History</p>
          <p class="text-xs text-white/60">View detailed logs of all searches and background jobs</p>
        </div>
        <a href="{% url 'logs' %}" class="rounded-xl bg-brand/20 px-4 py-2 text-sm font-semibold text-brand-light transition hover:bg-brand/30">View Logs ‚Üí</a>
      </div>
    </div>
  </div>
</section>

<section class="panel-surface mt-10 p-6 shadow-xl">
  <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
    <div>
      <p class="text-xs uppercase tracking-[0.3em] text-white/60">Distributed help</p>
      <h2 class="text-2xl font-semibold text-white">Bring your machine + Reddit account</h2>
      <p class="mt-2 text-sm text-white/80">Volunteer nodes get a private link via email‚Äîno login‚Äîto update or delete their entry anytime. Mark a node "broken" if it goes offline; anything broken for 7+ days is automatically removed during the nightly cleanup.</p>
    </div>
    <a href="{% url 'node_join' %}" class="rounded-2xl bg-gradient-to-r from-brand to-brand-light px-6 py-3 text-base font-semibold text-slate-950 shadow-brand transition hover:scale-[1.01]">Add a node</a>
  </div>
  <div class="mt-6 grid gap-4 md:grid-cols-2">
    <div class="rounded-2xl border border-white/10 bg-slate-900/40 p-4 text-sm text-white/70">
      <p class="text-xs uppercase tracking-[0.3em] text-white/50">Nodes in pool</p>
      <p class="mt-2 text-3xl font-semibold text-white">{{ node_stats.total|default:0 }}</p>
      <p class="mt-1 text-xs text-white/50">Active {{ node_stats.active|default:0 }} ‚Ä¢ Pending {{ node_stats.pending|default:0 }}</p>
    </div>
    <div class="rounded-2xl border border-white/10 bg-slate-900/40 p-4 text-sm text-white/70">
      <p class="text-xs uppercase tracking-[0.3em] text-white/50">Open source & contributor friendly</p>
      <p class="mt-2 text-base font-semibold text-white">Help build the largest trustworthy subreddit index</p>
      <div class="mt-3 flex gap-3">
        <a href="https://github.com/ericrosenberg1/reddit-sub-analyzer/issues" target="_blank" rel="noopener" class="nav-link text-xs">File an issue</a>
        <a href="https://github.com/ericrosenberg1/reddit-sub-analyzer/pulls" target="_blank" rel="noopener" class="nav-link text-xs">Submit PR</a>
      </div>
    </div>
  </div>
  {% if volunteer_nodes %}
  <ul class="mt-6 grid gap-4 lg:grid-cols-3">
    {% for node in volunteer_nodes %}
    <li class="rounded-2xl border border-white/10 bg-slate-900/50 p-4">
      <div class="flex items-center justify-between gap-3">
        <div>
          <p class="text-base font-semibold text-white">{% if node.reddit_username %}u/{{ node.reddit_username }}{% else %}Handle pending{% endif %}</p>
          <p class="text-xs text-white/60">{{ node.location|default:'Location TBD' }}</p>
        </div>
        <span class="rounded-full bg-white/10 px-3 py-1 text-xs font-semibold uppercase tracking-[0.2em] text-white/70">{{ node.health_status|default:'pending'|title }}</span>
      </div>
      <p class="mt-3 text-xs text-white/60">Last check-in: {{ node.last_check_in_at|date:"Y-m-d H:i T"|default:'New' }}</p>
      {% if node.notes %}<p class="mt-2 text-sm text-white/70">‚Äú{{ node.notes }}‚Äù</p>{% endif %}
    </li>
    {% endfor %}
  </ul>
  {% else %}
  <p class="mt-6 text-sm text-white/70">No volunteer nodes yet‚Äîadd yours to speed things up.</p>
  {% endif %}
</section>

{% endblock %}

{% block scripts %}
<script>
  function formatLocalTime(ts) {
    if (!ts) {
      return '‚Äî';
    }
    const date = new Date(ts);
    if (Number.isNaN(date.getTime())) {
      return '‚Äî';
    }
    // US style formatting: MM/DD/YYYY, H:MM AM/PM
    return date.toLocaleString('en-US', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: 'numeric',
      minute: '2-digit',
      hour12: true,
      timeZoneName: 'short',
    });
  }

  function refreshLocalTimeElements() {
    document.querySelectorAll('.local-time').forEach((el) => {
      const ts = el.getAttribute('data-ts');
      el.textContent = formatLocalTime(ts);
    });
  }

  // Format seconds to human-readable time
  function formatETA(seconds) {
    if (seconds < 60) {
      return `${seconds}s`;
    }
    const minutes = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return secs > 0 ? `${minutes}m ${secs}s` : `${minutes}m`;
  }

  // Auto-refresh queue status every 3 seconds
  let queueRefreshTimer = null;

  async function refreshQueueStatus() {
    try {
      const response = await fetch('/api/queue?limit=10');
      if (!response.ok) return;

      const data = await response.json();
      if (!data) return;

      const section = document.getElementById('queue-status-section');
      const queueList = document.getElementById('queue-list');
      const totalQueuedEl = document.getElementById('total-queued');
      const runningCountEl = document.getElementById('running-count');

      if (!section || !queueList) return;

      // Update counts
      if (totalQueuedEl) totalQueuedEl.textContent = data.total_queued || 0;
      if (runningCountEl) runningCountEl.textContent = data.running_count || 0;

      // Show/hide queue section
      if (data.queue && data.queue.length > 0) {
        section.style.display = 'block';

        // Build queue items HTML
        const itemsHTML = data.queue.map((item, index) => {
          const priorityBadge = item.is_manual
            ? '<span class="rounded-full bg-brand/30 px-2 py-1 text-xs font-semibold text-brand">User</span>'
            : '<span class="rounded-full bg-slate-500/30 px-2 py-1 text-xs font-semibold text-slate-300">Auto</span>';

          const etaStart = item.eta_start_seconds > 0 ? formatETA(item.eta_start_seconds) : 'Now';
          const etaComplete = formatETA(item.eta_completion_seconds);

          return `
            <div class="rounded-2xl border border-white/10 bg-slate-900/50 p-4">
              <div class="flex flex-wrap items-center justify-between gap-2">
                <div class="flex items-center gap-3">
                  <span class="text-lg font-bold text-white/40">#${item.position}</span>
                  <div class="flex flex-col">
                    <span class="text-base font-semibold text-white">${item.keyword}</span>
                    <span class="text-xs text-white/60">Limit: ${item.limit}</span>
                  </div>
                </div>
                ${priorityBadge}
              </div>
              <div class="mt-3 flex flex-wrap items-center gap-4 text-xs text-white/70">
                <span>üïê Start in: <strong class="text-sky-300">${etaStart}</strong></span>
                <span>‚úì Done in: <strong class="text-emerald-300">${etaComplete}</strong></span>
              </div>
            </div>
          `;
        }).join('');

        queueList.innerHTML = itemsHTML;
      } else {
        section.style.display = 'none';
      }
    } catch (error) {
      console.error('Failed to refresh queue status:', error);
    }
  }

  // Auto-refresh recent searches every 5 seconds
  let recentSearchesRefreshTimer = null;

  async function refreshRecentSearches() {
    try {
      const response = await fetch('/api/recent-runs?limit=5');
      if (!response.ok) return;

      const data = await response.json();
      if (!data || !data.runs) return;

      const listEl = document.getElementById('recent-searches-list');
      if (!listEl) return;

      // Update existing items or add new ones
      data.runs.forEach((run, index) => {
        let itemEl = listEl.querySelector(`[data-run-id="${run.job_id}"]`);

        if (!itemEl && index < listEl.children.length) {
          // Replace old item with new run
          itemEl = listEl.children[index];
          itemEl.setAttribute('data-run-id', run.job_id);
        }

        if (itemEl) {
          // Update status badge
          const statusBadge = itemEl.querySelector('.status-badge');
          if (statusBadge) {
            const status = run.completed_at ? 'complete' : (run.error ? 'error' : 'running');
            statusBadge.className = 'status-badge rounded-full px-3 py-1 text-xs font-semibold uppercase tracking-[0.2em]';
            if (status === 'complete') {
              statusBadge.className += ' bg-emerald-500/15 text-emerald-200';
            } else if (status === 'error') {
              statusBadge.className += ' bg-red-500/15 text-red-200';
            } else {
              statusBadge.className += ' bg-sky-500/15 text-sky-200';
            }
            statusBadge.textContent = status;
          }

          // Update result count
          const countEl = itemEl.querySelector('.result-count');
          if (countEl) {
            countEl.textContent = `${run.result_count || 0} subs`;
          }
        }
      });

      refreshLocalTimeElements();
    } catch (error) {
      console.error('Failed to refresh recent searches:', error);
    }
  }

  // Job polling for active search
  const jobIdFromServer = {% if job_id %}"{{ job_id }}"{% else %}null{% endif %};
  let pollTimer = null;
  let activeJobId = jobIdFromServer;

  async function fetchStatus(id){
    try {
      const res = await fetch(`/status/${id}`);
      if (!res.ok) return;
      const data = await res.json();
      if (!data) return;
      updateStatusUi(data);
      if (data.done && pollTimer){
        clearInterval(pollTimer);
        pollTimer = null;
      }
    } catch (err) {
      console.error(err);
    }
  }

  function updateStatusUi(data){
    const limit = Number(data.limit || data.job_config?.limit || 0);
    const checked = Number(data.checked || 0);
    const found = Number(data.found || 0);

    const limitEl = document.getElementById('limit_count');
    const checkedEl = document.getElementById('checked');
    const foundEl = document.getElementById('found');

    if(limitEl) limitEl.textContent = limit.toLocaleString();
    if(checkedEl) checkedEl.textContent = checked.toLocaleString();
    if(foundEl) foundEl.textContent = found.toLocaleString();

    const state = data.state || (data.done ? 'complete' : 'running');
    const statusTitle = document.getElementById('status-title');
    const statusSub = document.getElementById('status-sub');
    const runState = document.getElementById('run-state');
    const resultsPanel = document.getElementById('results-panel');

    if (state === 'queued'){
      if(statusTitle) statusTitle.textContent = 'Queued...';
      if(statusSub) statusSub.textContent = 'Waiting for available slot';
    } else if (state === 'running'){
      if(statusTitle) statusTitle.textContent = 'Running search...';
      if(statusSub) statusSub.textContent = `Checking subreddits for "${data.keyword || 'all'}"`;
    } else if (state === 'error'){
      if(statusTitle) statusTitle.textContent = 'Error';
      if(statusSub) statusSub.textContent = data.error || 'Unknown error';
    } else {
      if(statusTitle) statusTitle.textContent = state === 'stopped' ? 'Search stopped' : 'Search complete';
      if(statusSub) statusSub.textContent = data.error ? data.error : 'Results ready below.';
    }

    const stopBtn = document.getElementById('stopBtn');
    if(stopBtn) stopBtn.disabled = !!data.done;

    if (data.done && data.results_ready){
      if(runState) runState.classList.add('hidden');
      if(resultsPanel) resultsPanel.classList.remove('hidden');
      const total = Number(data.result_count || found);
      const resultsTitle = document.getElementById('results-title');
      const resultsSubtitle = document.getElementById('results-subtitle');
      const downloadBtn = document.getElementById('download-btn');
      const viewAllBtn = document.getElementById('view-all-btn');

      if(resultsTitle) resultsTitle.textContent = `${total.toLocaleString()} subreddits found`;
      if(resultsSubtitle) resultsSubtitle.textContent = 'Use the buttons to download or view in All The Subs.';
      if(downloadBtn){
        downloadBtn.href = `/job/${activeJobId}/download.csv`;
        downloadBtn.classList.remove('pointer-events-none','opacity-50');
      }
      if(viewAllBtn){
        viewAllBtn.href = `/all-the-subs?job_id=${encodeURIComponent(activeJobId)}`;
        viewAllBtn.classList.remove('pointer-events-none','opacity-50');
      }
    }
  }

  // Toggle activity filter
  const activityEnabled = document.getElementById('activity_enabled');
  if(activityEnabled){
    activityEnabled.addEventListener('change', function(){
      const activityMode = document.getElementById('activity_mode');
      const activityDate = document.getElementById('activity_date');
      const on = this.checked;
      if(activityMode) activityMode.disabled = !on;
      if(activityDate) activityDate.disabled = !on;
      if(!on){
        if(activityMode) activityMode.value = 'any';
        if(activityDate) activityDate.value = '';
      }
    });
  }

  // Stop button
  const stopBtn = document.getElementById('stopBtn');
  if(stopBtn){
    stopBtn.addEventListener('click', async function(){
      if(!activeJobId) return;
      try{
        const res = await fetch(`/stop/${activeJobId}`, {method: 'POST'});
        if(res.ok){
          if(pollTimer){
            clearInterval(pollTimer);
            pollTimer = null;
          }
          fetchStatus(activeJobId);
        }
      }catch(err){
        console.error(err);
      }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    refreshLocalTimeElements();
    refreshRecentSearches();
    refreshQueueStatus();
    recentSearchesRefreshTimer = setInterval(refreshRecentSearches, 5000);
    queueRefreshTimer = setInterval(refreshQueueStatus, 3000);

    // Start polling if we have an active job
    if(activeJobId){
      const runState = document.getElementById('run-state');
      if(runState) runState.classList.remove('hidden');
      fetchStatus(activeJobId);
      pollTimer = setInterval(() => fetchStatus(activeJobId), 1000);
    }
  });

  // Clean up on page unload
  window.addEventListener('beforeunload', () => {
    if (recentSearchesRefreshTimer) {
      clearInterval(recentSearchesRefreshTimer);
    }
    if (queueRefreshTimer) {
      clearInterval(queueRefreshTimer);
    }
  });
</script>
{% endblock %}
