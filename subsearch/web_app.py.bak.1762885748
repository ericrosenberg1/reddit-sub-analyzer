import os
from .broadened_search import broadened_subreddit_search
import json
import logging
import threading
import time
import re
import smtplib
import ssl
import csv
import io
from collections import deque
from datetime import datetime, timezone, timedelta
from email.message import EmailMessage
from queue import Queue
from typing import Dict, List, Optional

import random
import requests

from flask import Flask, render_template, request, flash, redirect, url_for, session, make_response, jsonify, Response

def _env_bool(key: str, default: bool=False) -> bool:
    import os
    v = os.getenv(key, '')
    if v is None or v.strip() == '':
        return default
    return v.strip().lower() in ('1','true','yes','on')

def _export_requested():
    try:
        from flask import request
        v = (request.args.get('export') or '').strip().lower()
        return v in ('1','true','yes','on','csv')
    except Exception:
        return False

def _enable_csv_guard():
    import builtins
    orig_open = getattr(_enable_csv_guard, '_orig_open', None) or builtins.open
    def guard_open(file, *args, **kwargs):
        try:
            name = str(file)
        except Exception:
            name = ''
        if name.endswith('.csv') and 'subsearch_run_' in name:
            if not (_export_requested() or _env_bool('AUTO_CSV', False)):
                class _Null:
                    def __enter__(self): return self
                    def __exit__(self, *exc): return False
                    def write(self, *a, **k): pass
                    def writerow(self, *a, **k): pass
                    def writerows(self, *a, **k): pass
                    def flush(self): pass
                return _Null()
        return orig_open(file, *args, **kwargs)
    builtins.open = guard_open
    _enable_csv_guard._orig_open = orig_open

from dotenv import load_dotenv

# --- START SAFE FIND_UNMOD STUB ---
from . import auto_sub_search as _auto_sub_search
import inspect as _inspect

def _resolve_find_unmoderated():
    # Try common candidates in order of preference
    for name in (
        "find_unmoderated_subreddits",
        "find_unmoderated",
        "scan_unmoderated",
        "main"
    ):
        fn = getattr(_auto_sub_search, name, None)
        if callable(fn):
            return fn
    # Final fallback: harmless no-op
    def _no_op(*args, **kwargs):
        return []
    return _no_op

def _adapt_kwargs(fn, **kwargs):
    """Filter/rename kwargs so they match the target function signature."""
    try:
        sig = _inspect.signature(fn)
        params = sig.parameters
    except Exception:
        return kwargs  # safest

    # Common renames from caller -> callee
    mapping = {
        # caller_name : callee_name
        "limit": "limit",
        "max_results": "limit",
        "keywords": "keywords",
        "terms": "keywords",
        "lookback_days": "days",
        "days": "days",
        "skip_nsfw": "skip_nsfw",
        "only_unmoderated": "only_unmoderated",
        "dry_run": "dry_run",
        "subreddit": "subreddit",
    }
    # Apply renames into a temp dict
    renamed = {}
    for k, v in kwargs.items():
        callee_k = mapping.get(k, k)
        renamed[callee_k] = v

    # Keep only args the function accepts (unless it has **kwargs)
    accepts_var_kw = any(p.kind == p.VAR_KEYWORD for p in params.values())
    if accepts_var_kw:
        return renamed
    filtered = {k:v for k,v in renamed.items() if k in params}
    return filtered

def _make_adapted_callable(fn):
    def _wrapped(*args, **kwargs):
        kw = _adapt_kwargs(fn, **kwargs)
        return fn(*args, **kw)
    return _wrapped

_resolved = _resolve_find_unmoderated()
find_unmoderated_subreddits = _make_adapted_callable(_resolved)
# --- END SAFE FIND_UNMOD STUB ---




# Reuse core sub_search functions
from .build_info import get_current_build_number
from .storage import (
    fetch_latest_random_run,
    fetch_recent_runs,
    get_summary_stats,
    get_node_stats,
    get_config_warnings,
    list_public_nodes,
    init_db,
    create_volunteer_node,
    get_node_by_token,
    update_volunteer_node,
    delete_volunteer_node,
    mark_manage_link_sent,
    prune_broken_nodes,
    persist_subreddits,
    record_run_complete,
    record_run_start,
    search_subreddits,
    fetch_subreddits_by_job,
    get_run_id_by_job,
    get_job_filters,
)

import praw
import prawcore


load_dotenv()


